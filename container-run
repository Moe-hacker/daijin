#!/data/data/com.termux/files/usr/bin/bash
#########ç”¨äºæŒ‚è½½ç³»ç»Ÿå¹¶è¿è¡Œchroot#########
###### Github@Moe-hacker ######
#æˆ‘èŒæ•…æˆ‘åœ¨ï¼ğŸ˜†
#â€¢.,Â¸,.â€¢*Â¯`â€¢.,Â¸,.â€¢....â•­â”â”â”â”â”â”â”â”â”â”â•®
#`â€¢.,Â¸,.â€¢*Â¯`â€¢.,Â¸,.â€¢*Â¯.|:::::::::::/\:__:/\
#`â€¢.,Â¸,.â€¢*Â¯`â€¢.,Â¸,.â€¢* <|:::::::::::(ï½¡ â—Ï‰â—ï½¡)
#`â€¢.,Â¸,.â€¢*Â¯`â€¢.,Â¸,.â€¢*  â•°ã—---ã—---ï¼ªï½¥ï¾Ÿ
#ç¼–ç¨‹ç¬¬ä¸€æ³•åˆ™:å¦‚æœä½ çš„ä»£ç ä¸çŸ¥é“ä¸ºå•¥èƒ½è·‘èµ·æ¥ï¼Œå°±åˆ«å†åŠ¨å®ƒäº†ğŸ˜
#å€Ÿé‰´äº†ä¸€éƒ¨åˆ†andraxå¯åŠ¨è„šæœ¬ï¼Œé‡‡ç”¨ç›¸åŒçš„è®¸å¯è¯ã€‚
#å˜é‡åè®¾ç½®ğŸ§ï¼š
#${CHROOT_IMG}:å®¹å™¨é•œåƒæ–‡ä»¶
#${CHROOT_DIR}:chrootå®¹å™¨ç»å¯¹è·¯å¾„æˆ–æŒ‚è½½ç‚¹
#${SELINUX}:[on/off], æ˜¯å¦å…³é—­SELinux
#${HOSTNAME}:è®¾ç½®ä¸»æœºå
#${OUTPUT}:[on/off]æ˜¯å¦å¯ç”¨è¾“å‡º
#${SLEEP}:[on/off]æ˜¯å¦å¯ç”¨åœé¡¿
###### E-mail: moe-hacker@outlook.com ######
if [[ ! $(whoami) = "root" ]];then #åˆ¤æ–­ç”¨æˆ·ï¼Œå¦‚æœä¸æ˜¯rootç›´æ¥æŠ¥é”™å…³é—­
  echo -e "\033[31m[ERR!]  \033[35mPlease run the script with sudo\033[0m"
  exit
else
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Check] \033[34mDevice is rooted\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
fi
#åŠ è½½é…ç½®æ–‡ä»¶
if [[ ! -e /data/data/com.termux/files/usr/etc/container.conf ]];then # åˆ¤æ–­é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  echo -e "\033[31m[ERR!]  \033[35mcontainer.conf \033[31mdoes not exist. Please run \033[33m container configure \033[0m"
  exit
else
  export $(cat /data/data/com.termux/files/usr/etc/container.conf) #åŠ è½½é…ç½®
fi
if [[ ! -e ${CHROOT_DIR} ]];then #åˆ¤æ–­å®¹å™¨æ˜¯å¦å­˜åœ¨
  echo -e "\033[31m[ERR!] \033[35mContainer directory does not exist\033[0m"
  exit
fi
if [[ !${CHROOT_IMG} = "" ]] && [[ ! -e ${CHROOT_IMG} ]];then #å¦‚æœä½¿ç”¨å®¹å™¨é•œåƒï¼Œåˆ¤æ–­å…¶æ˜¯å¦å­˜åœ¨
  echo -e "\033[31m[ERR!] \033[35mImage file does not exist \033[0m"
  exit
fi
if [[ ${SELINUX} = "n" ]];then #åˆ¤æ–­æ˜¯å¦éœ€è¦å…³é—­selinux
  if [[ ! $(getenforce) = "Permissive" ]];then
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mDisable \033[35mSELinux\033[0m"
    [[ ${SLEEP} = "n" ]] || sleep 0.3s
    setenforce 0 >/dev/null 2>&1 #å…³é—­SELinux [!]å±é™©æ“ä½œ
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mDisable \033[35mSELinux\033[0m"
  fi
fi
if [[ ! ${HOSTNAME} = "" ]];then #åˆ¤æ–­ä¸»æœºåè®¾ç½®æ˜¯å¦ä¸ºç©ºå€¼
  if [[ ! $(hostname) = ${HOSTNAME} ]];then
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mSet \033[35mhostname\033[0m"
    [[ ${SLEEP} = "n" ]] || sleep 0.3s
    hostname ${HOSTNAME} >/dev/null 2>&1 #è®¾ç½®ä¸»æœºå
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mSet \033[35mhostname\033[0m"
  fi
fi
############################################
#####  ä¸‹é¢è¿™æ®µå€Ÿé‰´äº†andraxçš„å¯åŠ¨è„šæœ¬  #####
#####åŠ å…¥æŠŠç³»ç»Ÿå®‰è£…åœ¨ imgé•œåƒæ–‡ä»¶çš„é€‰é¡¹#####
#####    ä¿®å¤äº†é•œåƒæ–‡ä»¶ç»“æ„éœ€è¦æ¸…ç†    #####
#####           åŠ å…¥ä¸€äº›åˆ¤æ–­           #####
#####  ä¿®å¤äº†sudoæ— æ³•ä½¿ç”¨(æœªå®Œå…¨è§£å†³)  #####
#####    ä¿®å¤äº†pacmanæ— æ³•åˆ†ææŒ‚è½½ç‚¹    #####
#####    ä¿®å¤æœªè®¾ç½®dnså¯¼è‡´æ— æ³•è”ç½‘     #####
#####      åŠ å…¥æ²¡å•¥ç”¨çš„è¾“å‡ºå’Œåœé¡¿      #####
############################################
#åˆ›å»ºä¸€äº›ç”±äºandroidå’Œæ™®é€šlinuxä¹‹é—´çš„å·®å¼‚è€Œä¸å­˜åœ¨çš„æ–‡ä»¶
if [[ ! -e /dev/fd ]];then
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mCreat \033[35m/dev/fd\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  ln -s /proc/self/fd /dev/ >/dev/null 2>&1
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mCreat \033[35m/dev/fd\033[0m"
fi
if [[ ! -e /dev/stdin ]];then
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mCreat \033[35m/dev/stdin\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  ln -s /proc/self/fd/0 /dev/stdin  >/dev/null 2>&1
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mCreat \033[35m/dev/stdin\033[0m"
fi
if [[ ! -e /dev/stdout ]];then
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mCreat \033[35m/dev/stdout\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  ln -s /proc/self/fd/1 /dev/stdout >/dev/null 2>&1
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mCreat \033[35m/dev/stdout \033[0m"
fi
if [[ ! -e /dev/stderr ]] ;then
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mCreat \033[35m/dev/stderr\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  ln -s /proc/self/fd/2 /dev/stderr >/dev/null 2>&1
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mCreat \033[35m/dev/stderr\033[0m"
fi
if [[ ! -e /dev/tty0 ]];then
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mCreat \033[35m/dev/tty0\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  ln -s /dev/null /dev/tty0 >/dev/null 2>&1
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mCreat  \033[35m/dev/tty0\033[0m"
fi
if [[ ! -e /dev/net/tun ]];then
  if [[ ! -d /dev/net ]];then
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mCreat \033[35m/dev/net\033[0m"
    [[ ${SLEEP} = "n" ]] || sleep 0.3s
    mkdir -p /dev/net >/dev/null 2>&1
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mCreat \033[35m/dev/net\033[0m"
   fi
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mCreat \033[35m/dev/net/tun\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  mknod /dev/net/tun c 10 200  >/dev/null 2>&1
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mCreat \033[35m/dev/net/tun\033[0m"
fi
#æŒ‚è½½ç³»ç»Ÿ
if [[ $(mount|grep ${CHROOT_DIR}) =  "" ]];then #åˆ¤æ–­å®¹å™¨è‡ªèº«æ˜¯å¦è¢«æŒ‚è½½ï¼Œç”±äºå®¹å™¨è‡ªèº«åœ¨è¿è¡Œè„šæœ¬æ—¶ç¬¬ä¸€ä¸ªè¢«æŒ‚è½½ï¼Œæ•…é‡‡ç”¨åˆ¤æ–­æŒ‚è½½ç‚¹æ˜¯å¦ä¸ºç©ºçš„æ–¹æ³•
  if [[ ${CHROOT_IMG} = "" ]];then
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mReMount \033[35m/data\033[0m"
    [[ ${SLEEP} = "n" ]] || sleep 0.3s
    mount -o remount,suid /data  >/dev/null 2>&1 #å°†data åˆ†åŒºé‡æ–°æŒ‚è½½ï¼Œå¯ç”¨suid,è§£å†³sudoç”±äºnosuidæŒ‚è½½æ— æ³•ä½¿ç”¨é—®é¢˜( è§£å†³äº†ï¼Œä½†æ²¡å®Œå…¨è§£å†³ï¼Œå¯¹äºä¸€äº›é‡‡ç”¨vabåˆ†åŒºçš„æ‰‹æœºå¯èƒ½æ— æ•ˆï¼Œæ¯”å¦‚æˆ‘çš„k40proå°±æ˜¯vabåˆ†åŒºï¼Œæ‰€ä»¥æ— æ•ˆ)
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mReMount \033[35m/data\033[0m"
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mMount \033[35m${CHROOT_DIR} \033[0m"
    [[ ${SLEEP} = "n" ]] || sleep 0.3s
    mount --rbind ${CHROOT_DIR} ${CHROOT_DIR} >/dev/null 2>&1 #å°†å®¹å™¨ç›®å½•æŒ‚è½½åˆ°è‡ªèº«ï¼Œè§£å†³pacmanæ— æ³•ä½¿ç”¨
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mMount \033[35m${CHROOT_DIR} \033[0m"
  else
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mRun \033[35mfsck\033[0m"
    [[ ${SLEEP} = "n" ]] || sleep 0.3s
    fsck.ext4 -a -f  ${CHROOT_IMG} >/dev/null 2>&1 #ä¿®å¤ç»“æ„éœ€è¦æ¸…ç†æŠ¥é”™ï¼Œæœ‰ä¸€å®šæ•ˆæœ
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mRun \033[35mfsck\033[0m"
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mMount \033[35m${CHROOT_IMG} \033[0m"
    [[ ${SLEEP} = "n" ]] || sleep 0.3s
    loop=$(losetup -f) #æŸ¥æ‰¾æœªä½¿ç”¨çš„loopæ–‡ä»¶
    losetup  ${loop} ${CHROOT_IMG}  >/dev/null 2>&1
    mount  ${loop} ${CHROOT_DIR}  >/dev/null 2>&1
    [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mMount \033[35m${CHROOT_IMG} \033[0m"
  fi
fi
#åˆ›å»ºrootfsä¸­å¯èƒ½ä¸å­˜åœ¨çš„æ–‡ä»¶,æš‚æ—¶ä¸åŠ è¾“å‡º
if [[ ! -e ${CHROOT_DIR}/dev || ! -e ${CHROOT_DIR}/proc || ! -e ${CHROOT_DIR}/sys ]]; then
  [[ -e ${CHROOT_DIR}/dev ]] || mkdir ${CHROOT_DIR}/dev
  [[ -e ${CHROOT_DIR}/proc ]] || mkdir ${CHROOT_DIR}/proc
  [[ -e ${CHROOT_DIR}/sys ]] || mkdir ${CHROOT_DIR}/sys 
fi
#ä¿®å¤ç½‘ç»œé—®é¢˜
if [[ $(cat ${CHROOT_DIR}/etc/hosts|grep ${HOSTNAME}) = "" ]];then
  echo 127.0.0.1 ${HOSTNAME} >> ${CHROOT_DIR}/etc/hosts #ä¿®å¤sudoæŠ¥é”™æ— æ³•è§£æä¸»æœº
fi
if [[ -L ${CHROOT_DIR}/etc/resolv.conf || ! -e ${CHROOT_DIR}/etc/resolv.conf ]];then
  rm -f ${CHROOT_DIR}/etc/resolv.conf >/dev/null 2>&1
  echo nameserver 114.114.114.114 >> ${CHROOT_DIR}/etc/resolv.conf #è§£å†³æœªè®¾ç½®dnså¯¼è‡´æ— æ³•è”ç½‘
fi
#æŒ‚è½½å†…ç½®å­˜å‚¨ï¼Œç”±äºè§£é™¤æŒ‚è½½ä¼šå¯¼è‡´å®¿ä¸»æœº/sdcardæ— æ³•è®¿é—®ï¼Œæ­¤å¤„å¼ƒå‘
if [[ $(mount|grep ${CHROOT_DIR}|grep /sdcard) =  "" ]];then #åˆ¤æ–­/procæ˜¯ å¦è¢«æŒ‚è½½
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mMount \033[35m/sdacrd\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  mkdir ${CHROOT_DIR}/sdcard >/dev/null 2>&1
  mount -o ro,bind /sdcard ${CHROOT_DIR}/sdcard/ >/dev/null 2>&1
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mMount \033[35m/sdacrd\033[0m"
fi
#æŒ‚è½½ç³»ç»Ÿæ–‡ä»¶
if [[ $(mount|grep ${CHROOT_DIR}|grep /proc) =  "" ]];then #åˆ¤æ–­/procæ˜¯ å¦è¢«æŒ‚è½½
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mMount \033[35m/proc\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  mount -t proc proc  ${CHROOT_DIR}/proc/ >/dev/null 2>&1
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mMount \033[35m/proc\033[0m"
fi
if [[ ! -e ${CHROOT_DIR}/dev/block ]];then #åˆ¤æ–­/devæ˜¯å¦è¢«æŒ‚è½½
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mMount \033[35m/dev\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  mount --rbind /dev ${CHROOT_DIR}/dev/ >/dev/null 2>&1
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mMount \033[35m/dev\033[0m"
fi
if [[ $(mount|grep ${CHROOT_DIR}|grep /sys) =  "" ]];then #åˆ¤æ–­/sysæ˜¯å¦ è¢«æŒ‚è½½
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mMount \033[35m/sys\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  mount --rbind /sys ${CHROOT_DIR}/sys/ >/dev/null 2>&1
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mMount \033[35m/sys\033[0m"
fi
#æŒ‚è½½ä¸€äº›æ–‡ä»¶åˆ°ç³»ç»Ÿï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºå•¥ï¼Œè²Œä¼¼åŸé¡¹ç›®å°±è¿™æ ·å†™çš„
if [[ ! -e /dev/shm ]] || [[ ! -e ${CHROOT_DIR}/dev/shm ]];then
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mCreat directory \033[35m/dev/shm\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  mkdir -p /dev/shm ${CHROOT_DIR}/dev/shm >/dev/null 2>&1 #åˆ›å»º/dev/shm
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mCreat directory \033[35m/dev/shm\033[0m"
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mMount \033[35mtmpfs\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  mount -o rw,nosuid,nodev,mode=1777 -t tmpfs tmpfs /dev/shm >/dev/null 2>&1 #æŒ‚è½½tmpfs
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mMount \033[35mtmpfs\033[0m"
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mMount \033[35m/dev/shm\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  mount --bind /dev/shm ${CHROOT_DIR}/dev/shm >/dev/null 2>&1 #æŒ‚è½½/dev/shm
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mMount \033[35m/dev/shm\033[0m"
fi
if  [[ ! -e ${CHROOT_DIR}/dev/pts/1 ]];then
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mMount \033[35m/dev/pts\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  mkdir ${CHROOT_DIR}/dev/pts >/dev/null 2>&1
  mount --bind /dev/pts ${CHROOT_DIR}/dev/pts >/dev/null 2>&1
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mMount \033[35m/dev/pts\033[0m"
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mChange mode of \033[35m/dev/null\033[0m"
  [[ ${SLEEP} = "n" ]] || sleep 0.3s
  chmod 666 /dev/null >/dev/null 2>&1
  [[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Done]  \033[34mChange mode of \033[35m/dev/null\033[0m"
fi
[[ ${OUTPUT} = "n" ]] || echo -e "\033[32m[Start] \033[34mRun chroot\033[0m"
[[ ${SLEEP} = "n" ]] || sleep 0.3s
unset TMP TEMP TMPDIR LD_PRELOAD LD_DEBUG ZPFX ZSH_CACHE PATH #åˆ é™¤éƒ¨åˆ†ç¯å¢ƒå˜é‡
/bin/chroot ${CHROOT_DIR} /bin/su - root
