#!/data/data/com.termux/files/usr/bin/bash
# â–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—
#â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
#â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
#â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•šâ•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘ â•šâ•â•â•â•â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘
#â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
# â•šâ•â• â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•  â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•â• â•šâ•â•  â•šâ•â•
#æœ¬è„šæœ¬å°†ä¼šè¢«é‡æ„
#å¯èƒ½åŒ…å«ï¼š
#å±å±±é€»è¾‘ï¼Œç©ºå£³å‡½æ•°ï¼Œæ²¡ç”¨çš„åå¤è°ƒç”¨ï¼Œæ²¡ç”¨çš„åŠŸèƒ½ï¼Œè„‘æº¢è¡€è®¾è®¡
###### Github@Moe-hacker ######
#â€¢.,Â¸,.â€¢*Â¯`â€¢.,Â¸,.â€¢....â•­â”â”â”â”â”â”â”â”â”â•®
#`â€¢.,Â¸,.â€¢*Â¯`â€¢.,Â¸,.â€¢*Â¯.|::::::::::/\__/\
#`â€¢.,Â¸,.â€¢*Â¯`â€¢.,Â¸,.â€¢* <|:::::::::(ï½¡ â—Ï‰â—ï½¡)
#`â€¢.,Â¸,.â€¢*Â¯`â€¢.,Â¸,.â€¢*  â•°ã—--ã—--ï¼ªï½¥ï¾Ÿ
###### E-mail: moe-hacker@outlook.com ######
######  Blog: cnblogs.com/Moe-hacker  ######
#ç”¨äºä½¿whiptailé€‚åº”å±å¹•åˆ†è¾¨ç‡
#è¿™ä¸ªå˜é‡çš„ä½œç”¨æˆ‘ç”šè‡³ç¿»äº†ä¸‹è°ƒç”¨æ‰æƒ³èµ·æ¥
export WIDTH=$(($(stty size|awk '{print $2}')-8))
#åŠ è½½å…¨å±€é…ç½®
LOAD_GLOBAL_CONFIG(){
  if [[ -e $PREFIX/etc/container/global.conf ]];then
    source $PREFIX/etc/container/global.conf
  else
    echo -e "\a\033[31m[ï‘¯]é”™è¯¯:æœªæ‰¾åˆ°å…¨å±€é…ç½®!"
    exit 1
  fi
}
#åŠ è½½å®¹å™¨é…ç½®
LOAD_CONTAINER_CONFIG(){
  if [[ -e $PREFIX/etc/container/container-${CONTAINER}.conf ]];then
    source $PREFIX/etc/container/container-${CONTAINER}.conf
  else
    echo -e "\a\033[31m[ï‘¯]é”™è¯¯:æœªæ‰¾åˆ°å®¹å™¨ï¼Œä½ å¯èƒ½éœ€è¦æ‰§è¡Œcontainer -Sæ¥åˆ‡æ¢å®¹å™¨æˆ–container -cæ¥åˆ›å»ºä¸€ä¸ªå®¹å™¨"
    exit 1
  fi
}
#è·å–æ‰‹æœºæ¶æ„
#è™½ç„¶çœŸæ²¡å¬è¯´è¿‡amd64çš„æ‰‹æœº
GET_CPU_ARCH(){
  DPKG_ARCH=$(dpkg --print-architecture)
  case ${DPKG_ARCH} in
    armel) export ARCH="armel" ;;
    armv7* | armv8l | armhf | arm) export ARCH="armhf" ;;
    aarch64 | arm64* | armv8* | arm*) export ARCH="arm64" ;;
    i*86 | x86) export ARCH="i386" ;;
    x86_64 | amd64) export ARCH="amd64" ;;
    *) whiptail --title "[ï‘¯] é”™è¯¯" --msgbox "æœªçŸ¥cpuæ¶æ„!" 7 $WIDTH&&exit 1 ;;
  esac
  return 0
}
#è‡ªåŠ¨è·å–rootfsä¸‹è½½é“¾æ¥
DOWNLOAD_ROOTFS(){
  LIST="1 almalinux 2 alpine 3 alt 4 amazonlinux 5 apertis 6 archlinux 7 centos 8 debian 9 devuan 10 fedora 11 gentoo 12 kali 13 opensuse 14 oracle 15 parrot 16 rockylinux 17 ubuntu 18 voidlinux"
  LIST2="almalinux alpine alt amazonlinux apertis archlinux centos debian devuan fedora gentoo kali opensuse oracle parrot rockylinux ubuntu voidlinux"
  NUMBER=$(whiptail --title "[îœ’] ç³»ç»Ÿ" --menu "è¯·é€‰æ‹©è¦å®‰è£…çš„ç³»ç»Ÿ:" 15 $WIDTH 6 $LIST 3>&1 1>&2 2>&3)
  OS=$(echo $LIST2|awk "{print \$$NUMBER}")
  unset LIST LIST2 NUMBER
  if [[ ${OS} != "parrot" ]];then
    NUMBER=0
    for VERSION in $(curl -sL http://images.linuxcontainers.org/images/$OS|grep "DIR"|sed -E 's@<a (href)@\n\1@g'| awk -F 'href=' '{print $2}' | cut -d '"' -f 2 |cut -d "/" -f 1);do NUMBER=$(($NUMBER+1));LIST+="$NUMBER $VERSION ";LIST2+="$VERSION ";done
    unset VERSION NUMBER
    NUMBER=$(whiptail --title "[îœ’] ç‰ˆæœ¬å·" --menu "è¯·é€‰æ‹©è¦å®‰è£…çš„ç³»ç»Ÿç‰ˆæœ¬å·:" 15 $WIDTH 6 $LIST 3>&1 1>&2 2>&3)
    VERSION=$(echo $LIST2|awk "{print \$$NUMBER}")
  fi
  if [[ ${CROSS_ARCH} != "null" && ${CROSS_ARCH} != "" ]];then
    case ${CROSS_ARCH} in
      "aarch64") export ARCH="arm64";;
      "arm") export ARCH="armhf";;
      "i386") export ARCH="i386";;
      "m68k") export ARCH="m68k";;
      "ppc") export ARCH="ppc";;
      "ppc64") export ARCH="ppc64";;
      "riscv32") export ARCH="riscv32";;
      "riscv64") export ARCH="riscv64";;
      "x86_64") export ARCH="amd64";;
    esac
  else
    GET_CPU_ARCH
  fi
  DOWNLOAD_COMMON_ROOTFS(){
    MIRROR="http://images.linuxcontainers.org/images"
    if [[ $OS = "gentoo" ]];then
      VERSION2="openrc"
    else
      VERSION2="default"
    fi
    TIME=$(curl -sL ${MIRROR}/${OS}/${VERSION}/${ARCH}/${VERSION2}|grep "DIR" |sed -E 's@<a (href)@\n\1@g'| awk -F 'href=' '{print $2}' | cut -d '"' -f 2 |cut -d "/" -f 2|tail -n 1)
    if [[ ${TIME} = "" ]];then
      whiptail --title "[ï‘¯] é”™è¯¯" --msgbox "æœªæ‰¾åˆ°rootfs!" 7 $WIDTH
      exit 1
    fi
    [[ -e $PREFIX/tmp/container ]]||mkdir -p $PREFIX/tmp/container
    cd $PREFIX/tmp/container
    URL=${MIRROR}/${OS}/${VERSION}/${ARCH}/${VERSION2}/${TIME}/rootfs.tar.xz
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[ï•‡] ä¸‹è½½rootfs"|pv -qL 40
    axel -n16 ${URL}
    return 0
  }
  DOWNLOAD_PARROT_ROOTFS(){
    mkdir -p $PREFIX/tmp/container
    cd $PREFIX/tmp/container
    ROOTFS=$(curl -sL https://mirrors.bfsu.edu.cn/parrot/iso/testing/|grep title|sed -E 's@<a (href)@\n\1@g'| awk -F 'href=' '{print $2}' | cut -d '"' -f 2|tail -n +5|grep ".tar.xz"|grep ${ARCH}|head -n 1)
    if [[ ${ROOTFS} = "" ]];then
      whiptail --title "[ï‘¯] é”™è¯¯" --msgbox "æœªæ‰¾åˆ°rootfs!" 7 $WIDTH
      exit 1
    fi
    URL="https://mirrors.bfsu.edu.cn/parrot/iso/testing/${ROOTFS}"
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[ï•‡] ä¸‹è½½rootfs"|pv -qL 40
    axel -n16 ${URL}
    echo "\e[38;5;159m[ïŸ¼] æ­£åœ¨æ„å»ºparrotçš„rootfsï¼Œè¿™å¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´..."
    sleep 2s
    tar -xvf ${ROOTFS}
    cd parrot-${ARCH}
    tar -cvJf ../rootfs.tar.xz .
    cd ..
    rm ${ROOTFS}
    rm -rf parrot-${ARCH}
    return 0
  }
  #æˆ–è®¸åŠ å…¥Manjaroæ”¯æŒï¼Ÿ
  case $OS in
      "parrot") DOWNLOAD_PARROT_ROOTFS;;
      *) DOWNLOAD_COMMON_ROOTFS;;
  esac
  return 0
}
#åˆ›å»ºchrootå®¹å™¨
#ä¼ ç»Ÿchrootå®¹å™¨å’Œchroot-unshareå®¹å™¨å…±äº«åˆ›å»ºè¿‡ç¨‹
CREATE_CHROOT_CONTAINER(){
  while :
  do
    NAME=$(whiptail --title "[ïš¦] å®¹å™¨å" --inputbox "è¯·è¾“å…¥å®¹å™¨å:" 7 $WIDTH 3>&1 1>&2 2>&3)
    if [[ $NAME != "" ]];then
      break
    fi
  done
  if whiptail --title "[ï”“] æ·»åŠ ç”¨æˆ·" --yes-button "yes" --no-button "no" --yesno "æ·»åŠ ä¸€ä¸ªæ–°çš„æ™®é€šç”¨æˆ·?" 7 $WIDTH;then
    while :
    do
      NEW_USER=$(whiptail --title "[ï”“] ç”¨æˆ·å" --inputbox "è¯·è¾“å…¥ç”¨æˆ·å:" 7 $WIDTH 3>&1 1>&2 2>&3)
      if [[ ${NEW_USER} != "" ]];then
        break
      fi
    done
    while :
    do
      PASSWORD=$(whiptail --title "[ï’œ] å¯†ç " --passwordbox "è¯·è¾“å…¥å¯†ç :" 7 $WIDTH 3>&1 1>&2 2>&3)
      if [[ ${PASSWORD} != "" ]];then
        break
      fi
    done
  fi
  whiptail --title "[ï™] å¸®åŠ©ä¿¡æ¯" --msgbox "å®¹å™¨ç»å¯¹è·¯å¾„æ˜¯ç”¨æ¥å­˜æ”¾å®¹å™¨çš„è·¯å¾„ï¼Œä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨/data/å®¹å™¨åï¼Œä½†ä¸è¦ç”¨/sdcardä¸‹çš„ç›®å½•!" 9 $WIDTH
  while :
  do
    CONTAINER_DIR=$(whiptail --title "[î—¾] å®¹å™¨ç›®å½•" --inputbox "è¯·è¾“å…¥å®¹å™¨çš„ç»å¯¹è·¯å¾„:" 7 $WIDTH 3>&1 1>&2 2>&3)
    if [[ ${CONTAINER_DIR} != "" ]];then
      break
    fi
  done
  for BLACKLIST in {/bin/,/dev/,/odm/,/oem/,/proc/,/product/,/sys/,/system/,/vendor/};do
    if [[ $CONTAINER_DIR = $BLACKLIST* ]];then
      whiptail --title "[ï‘¯] é”™è¯¯" --msgbox "æ‹’ç»ä½¿ç”¨ç³»ç»Ÿç›®å½•!" 7 $WIDTH
      exit 1
    fi
  done
  if [[ -e $CONTAINER_DIR ]];then
    whiptail --title "[ï‘¯] é”™è¯¯" --msgbox "ç›®å½•å·²å­˜åœ¨!" 7 $WIDTH
    exit 1
  fi
  if whiptail --title "[î‰±] å®¹å™¨é•œåƒ" --yes-button "yes" --no-button "no" --yesno "ä½ æƒ³æŠŠå®¹å™¨å®‰è£…åœ¨é•œåƒæ–‡ä»¶ä¸­å—?" 7 $WIDTH;then
    whiptail --title "[ï™] å¸®åŠ©ä¿¡æ¯" --msgbox "å®¹å™¨é•œåƒç»å¯¹è·¯å¾„æ˜¯ç”¨æ¥å­˜æ”¾å®¹å™¨é•œåƒçš„ç›®å½•ï¼Œä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨/data" 9 $WIDTH
    while :
    do
      CONTAINER_IMG_PATH=$(whiptail --title "[î—¾] é•œåƒç›®å½•" --inputbox "è¯·è¾“å…¥å®¹å™¨é•œåƒç»å¯¹è·¯å¾„:" 7 $WIDTH 3>&1 1>&2 2>&3)
      if [[ $CONTAINER_IMG_PATH != "" ]];then
        break
      fi
    done
    if [[ $CONTAINER_IMG_PATH = $CONTAINER_DIR ]];then
      whiptail --title "[ï‘¯] é”™è¯¯" --msgbox "æ‹’ç»ä½¿ç”¨å’Œå®¹å™¨ç›¸åŒçš„è·¯å¾„!" 7 $WIDTH
      exit 1
    fi
    for BLACKLIST in {/bin/,/dev/,/odm/,/oem/,/proc/,/product/,/sys/,/system/,/vendor/};do
      if [[ $CONTAINER_IMG_PATH = $BLACKLIST* ]];then
        whiptail --title "[ï‘¯] é”™è¯¯" --msgbox "æ‹’ç»ä½¿ç”¨ç³»ç»Ÿç›®å½•!" 7 $WIDTH
        exit 1
      fi
    done
    while :
    do
      CONTAINER_IMG_NAME=$(whiptail --title "[î‰±] å®¹å™¨é•œåƒ" --inputbox "è¯·è¾“å…¥é•œåƒæ–‡ä»¶å:" 7 $WIDTH 3>&1 1>&2 2>&3)
      if [[ $CONTAINER_IMG_NAME != "" ]];then
        break
      fi
    done
    while :
    do
      SIZE=$(whiptail --title "[î‰±] å®¹å™¨é•œåƒ" --inputbox "è¯·è¾“å…¥é•œåƒæ–‡ä»¶å¤§å°(å•ä½ä¸ºGb):" 7 $WIDTH 3>&1 1>&2 2>&3)
      if [[ $SIZE != "" ]];then
        break
      fi
    done
  fi
  if whiptail --title "[îœ’] è‡ªåŠ¨è·å–rootfs" --yes-button "yes" --no-button "no" --yesno "è‡ªåŠ¨è·å–rootfsä¸‹è½½é“¾æ¥?" 7 $WIDTH;then
    AUTO_GET_LINK=y
  else
    AUTO_GET_LINK=n
  fi
  if [[ ${AUTO_GET_LINK} = "n" ]];then
    whiptail --title "[ï™] å¸®åŠ©ä¿¡æ¯" --msgbox "ä½ å¯ä»¥å» http://mirrors.tuna.tsinghua.edu.cn/lxc-images/images å»è·å–rootfsä¸‹è½½é“¾æ¥æˆ–ä½¿ç”¨è‡ªå®šä¹‰rootfs" 9 $WIDTH
    while :
    do
      LINK=$(whiptail --title "[îœ’] rootfs" --inputbox "è¯·è¾“å…¥rootfsä¸‹è½½é“¾æ¥æˆ–è€…è‡ªå®šä¹‰rootfsçš„ç»å¯¹è·¯å¾„:" 7 $WIDTH 3>&1 1>&2 2>&3)
      if [[ $LINK != "" ]];then
        break
      fi
    done
  fi
  rm -rf $PREFIX/tmp/container >> /dev/null 2>&1
  mkdir -p $PREFIX/tmp/container >> /dev/null 2>&1
  cd $PREFIX/tmp/container
  if [[ ${AUTO_GET_LINK} = "y" ]];then
    DOWNLOAD_ROOTFS
  else
    [[ ${ENABLE_OUTPUT} = "false" ]]||clear
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[ï•‡] ä¸‹è½½rootfs"|pv -qL 40
    wget ${LINK}||cp ${LINK} ./||exit 0
  fi
  if ! sudo mkdir -p ${CONTAINER_DIR};then
    whiptail --title "[ï‘¯] é”™è¯¯" --msgbox "æ— æ³•åˆ›å»ºå®¹å™¨ç›®å½•!" 7 $WIDTH
    rm -rf $PREFIX/tmp/container
    exit 1
  fi
  if [[ ${CONTAINER_IMG_NAME} != "" ]];then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[î‰±] åˆ›å»ºé•œåƒæ–‡ä»¶"|pv -qL 40
    if ! sudo mkdir -p ${CONTAINER_IMG_PATH};then
      whiptail --title "[ï‘¯] é”™è¯¯" --msgbox "æ— æ³•åˆ›å»ºé•œåƒæ–‡ä»¶ç›®å½•!"  7 $WIDTH
      exit 1
    fi
    cd ${CONTAINER_IMG_PATH}
    sudo dd if=/dev/zero of=${CONTAINER_IMG_NAME}.img bs=1G count=${SIZE}
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[ïŸ‰] åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ"|pv -qL 40
    sudo mkfs.ext4 ${CONTAINER_IMG_NAME}.img
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[î‰±] æŒ‚è½½é•œåƒæ–‡ä»¶"|pv -qL 40
    sleep 1s
    LOOPFILE=$(sudo losetup -f)
    sudo losetup  ${LOOPFILE} ${CONTAINER_IMG_NAME}.img  >> /dev/null 2>&1
    sudo mount ${LOOPFILE} ${CONTAINER_DIR}  >> /dev/null 2>&1
  fi
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[ï£•] è§£å‹rootfs"|pv -qL 40
  sleep 2s
  ROOTFS=$(ls $PREFIX/tmp/container/)
  case $ROOTFS in
    *tar.gz|*tgz) pv $PREFIX/tmp/container/$ROOTFS|tar -xzf - -C ${CONTAINER_DIR};;
    *tar.xz|*txz) pv $PREFIX/tmp/container/$ROOTFS|tar -xJf - -C ${CONTAINER_DIR};;
    *tar) pv $PREFIX/tmp/container/$ROOTFS|tar -xf - -C ${CONTAINER_DIR};;
    *) whiptail --title "[ï‘¯] é”™è¯¯" --msgbox "æœªçŸ¥æ–‡ä»¶æ ¼å¼!" 7 $WIDTH;exit 1;;
  esac
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[ï‘±] å†™å…¥é…ç½®æ–‡ä»¶"|pv -qL 40
  sleep 1s
  for i in {1..100};do
    if [[ ! -e $PREFIX/etc/container/container-${i}.conf ]];then
      CONTAINER=$i
      break
    fi
  done
  echo "#æ­¤æ–‡ä»¶ä¸ºtermux-containerè‡ªåŠ¨åˆ›å»º" >> $PREFIX/etc/container/container-${CONTAINER}.conf
  echo "#å¦‚æœä½ ä¸çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆ,ä¸è¦ç¼–è¾‘æ­¤æ–‡ä»¶!" >> $PREFIX/etc/container/container-${CONTAINER}.conf
  echo RUN_MODE=chroot-unshare >> $PREFIX/etc/container/container-${CONTAINER}.conf
  echo NAME=${NAME} >> $PREFIX/etc/container/container-${CONTAINER}.conf
  echo CONTAINER_DIR=${CONTAINER_DIR} >> $PREFIX/etc/container/container-${CONTAINER}.conf
  if [[ ${CONTAINER_IMG_NAME} != "" ]];then
    echo CONTAINER_IMG=${CONTAINER_IMG_PATH}/${CONTAINER_IMG_NAME}.img >> $PREFIX/etc/container/container-${CONTAINER}.conf
  else
    echo CONTAINER_IMG=null >> $PREFIX/etc/container/container-${CONTAINER}.conf
  fi
  export NEW_CONTAINER=${CONTAINER}
  LOAD_GLOBAL_CONFIG
  export CONTAINER_BK=${CONTAINER}
  unset CONTAINER
  sed -i "s/CONTAINER=$CONTAINER_BK/CONTAINER=$NEW_CONTAINER/" $PREFIX/etc/container/global.conf
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[ï’] åˆ é™¤å·²ä¸‹è½½çš„rootfs"|pv -qL 40
  sleep 1s
  rm -rf $PREFIX/tmp/container
  cd /data/data/com.termux/files/home
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[ï¥] ä¿®å¤ä¸­..."|pv -qL 40
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[ï“] åˆ›å»ºç³»ç»Ÿç›®å½•"|pv -qL 40
  [[ -e ${CONTAINER_DIR}/dev ]]||mkdir ${CONTAINER_DIR}/dev
  [[ -e ${CONTAINER_DIR}/proc ]]||mkdir ${CONTAINER_DIR}/proc
  [[ -e ${CONTAINER_DIR}/sys ]]||mkdir ${CONTAINER_DIR}/sys
  [[ -e ${CONTAINER_DIR}/sdcard ]]||mkdir ${CONTAINER_DIR}/sdcard
  if [[ $(cat ${CONTAINER_DIR}/etc/hosts|grep ${HOSTNAME}) = "" ]];then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[î˜”] ä¿®å¤sudo"|pv -qL 40
    echo 127.0.0.1 ${HOSTNAME} >> ${CONTAINER_DIR}/etc/hosts
  fi
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[ï ˜] ä¿®å¤dns"|pv -qL 40
  rm -f ${CONTAINER_DIR}/etc/resolv.conf >> /dev/null 2>&1
  echo nameserver 8.8.8.8 >> ${CONTAINER_DIR}/etc/resolv.conf
  echo nameserver 114.114.114.114 >> ${CONTAINER_DIR}/etc/resolv.conf
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[ï”“] æ·»åŠ ç”¨æˆ·ç»„"|pv -qL 40
  cp $PREFIX/share/termux-container/group_add.sh ${CONTAINER_DIR}/tmp
  chmod 777 ${CONTAINER_DIR}/tmp/group_add.sh
  if [[ ${NEW_USER} != "" && ${PASSWORD} != "" ]];then
    sed -i "s/NEW_USER=\"\"/NEW_USER=${NEW_USER}/" ${CONTAINER_DIR}/tmp/group_add.sh
    sed -i "s/PASSWORD=\"\"/PASSWORD=${PASSWORD}/" ${CONTAINER_DIR}/tmp/group_add.sh
  fi
  mount -t proc proc  ${CONTAINER_DIR}/proc/
  mount --rbind /dev ${CONTAINER_DIR}/dev/
  mount --rbind /sys ${CONTAINER_DIR}/sys/
  unset LD_PRELOAD
  $PREFIX/bin/chroot ${CONTAINER_DIR} /tmp/group_add.sh >> /dev/null 2>&1
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[ï’‰] å¤åˆ¶åˆå§‹åŒ–è„šæœ¬"|pv -qL 40
  mkdir -p ${CONTAINER_DIR}/usr/local/bin >> /dev/null 2>&1
  cp $PREFIX/share/termux-container/unshare_init ${CONTAINER_DIR}/usr/local/bin/
  chmod 777 ${CONTAINER_DIR}/usr/local/bin/unshare_init
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[ï›ƒ] è®¾ç½®ä¸»æœºå"|pv -qL 40
  echo ${HOSTNAME} > ${CONTAINER_DIR}/etc/hostname
  if [[ ${ENABLE_OUTPUT} = "y" ]];then
    touch ${CONTAINER_DIR}/etc/enable_output
  fi
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[ï’‰] è§£é™¤å®¹å™¨æŒ‚è½½"|pv -qL 40
  umount -lvf ${CONTAINER_DIR}/dev >> /dev/null 2>&1
  umount -lvf ${CONTAINER_DIR}/sys >> /dev/null 2>&1
  umount -lvf ${CONTAINER_DIR}/proc >> /dev/null 2>&1
  umount -lvf ${CONTAINER_DIR} >> /dev/null 2>&1
  losetup -d ${CONTAINER_IMG} >> /dev/null 2>&1
  echo -e "[ï˜] åˆ›å»ºå®Œæ¯•!"
  return 0
  exit 0
}
#åˆ›å»ºprootå®¹å™¨
#æœ¬äººç”¨ä¸åˆ°ï¼Œä½†æ˜¯ä¼šæœ‰äººç”¨çš„ä¸Šï¼Œä¸æ˜¯å—ï¼Ÿ
#çœŸè¯´ç”¨é€”ï¼Œç›®å‰æ•´ä¸ªé¡¹ç›®å¯¹æˆ‘æ²¡å¤ªå¤§ç”¨é€”ï¼Œå› ä¸ºæ—©å°±å¼€å§‹åœ¨æ‰‹æœºä¸Šè·‘dockeräº†
CREATE_PROOT_CONTAINER(){
  while :
  do
    NAME=$(whiptail --title "[ïš¦] å®¹å™¨å" --inputbox "è¯·è¾“å…¥å®¹å™¨å:" 7 $WIDTH 3>&1 1>&2 2>&3)
    if [[ $NAME != "" ]];then
      break
    fi
  done
  if whiptail --title "[ï”“] æ·»åŠ ç”¨æˆ·" --yes-button "yes" --no-button "no" --yesno "æ·»åŠ ä¸€ä¸ªæ–°çš„æ™®é€šç”¨æˆ·?" 7 $WIDTH;then
    while :
    do
      NEW_USER=$(whiptail --title "[ï”“] ç”¨æˆ·å" --inputbox "è¯·è¾“å…¥ç”¨æˆ·å:" 7 $WIDTH 3>&1 1>&2 2>&3)
      if [[ ${NEW_USER} != "" ]];then
        break
      fi
    done
    while :
    do
      PASSWORD=$(whiptail --title "[ï’œ] å¯†ç " --passwordbox "è¯·è¾“å…¥å¯†ç :" 7 $WIDTH 3>&1 1>&2 2>&3)
      if [[ ${PASSWORD} != "" ]];then
        break
      fi
    done
  whiptail --title "[î˜”] å…³äºsudo" --msgbox "å¦‚æœsudoä¸å¯ç”¨ï¼Œè¯·é‡æ–°å®‰è£…sudo." 7 $WIDTH
  fi
  whiptail --title "[ï™] å¸®åŠ©ä¿¡æ¯" --msgbox "å®¹å™¨ç»å¯¹è·¯å¾„æ˜¯ç”¨æ¥å­˜æ”¾å®¹å™¨çš„è·¯å¾„ï¼Œå»ºè®®ä½¿ç”¨/data/data/com.termux/files/home/å®¹å™¨åï¼Œä½†å°½é‡ä¸è¦ç”¨/sdcardä¸‹çš„ç›®å½•!" 9 $WIDTH
  while :
  do
    CONTAINER_DIR=$(whiptail --title "[î—¾] å®¹å™¨ç›®å½•" --inputbox "è¯·è¾“å…¥å®¹å™¨çš„ç»å¯¹è·¯å¾„:" 7 $WIDTH 3>&1 1>&2 2>&3)
    if [[ ${CONTAINER_DIR} != "" ]];then
      break
    fi
  done
  if [[ -e $CONTAINER_DIR ]];then
    whiptail --title "[ï‘¯] è­¦å‘Š" --msgbox "ç›®å½•å·²å­˜åœ¨!" 7 $WIDTH
  fi
  if whiptail --title "[ï’™] è·¨æ¶æ„" --yes-button "yes" --no-button "no" --yesno "è·¨æ¶æ„è¿è¡Œå®¹å™¨?" 7 $WIDTH;then
    LIST="1 aarch64 2 arm 3 i386 4 m68k 5 ppc 6 ppc64 7 riscv32 8 riscv64 9 x86-64"
    ARCH=$(whiptail --title "[ï’™] è·¨æ¶æ„" --menu "è¯·é€‰æ‹©è¦æ¨¡æ‹Ÿçš„æ¶æ„:" 15 $WIDTH 6 $LIST 3>&1 1>&2 2>&3)
    case ${ARCH} in
      "1") apt install qemu-user-aarch64&&export CROSS_ARCH="aarch64";;
      "2") apt install qemu-user-arm&&export CROSS_ARCH="arm";;
      "3") apt install qemu-user-i386&&export CROSS_ARCH="i386";;
      "4") apt install qemu-user-m68k&&export CROSS_ARCH="m68k";;
      "5") apt install qemu-user-ppc&&export CROSS_ARCH="ppc";;
      "6") apt install qemu-user-ppc64&&export CROSS_ARCH="ppc64";;
      "7") apt install qemu-user-riscv32&&export CROSS_ARCH="riscv32";;
      "8") apt install qemu-user-riscv64&&export CROSS_ARCH="riscv64";;
      "9") apt install qemu-user-x86-64&&export CROSS_ARCH="x86_64";;
    esac
  else
    export CROSS_ARCH="null"
  fi
  if whiptail --title "[îœ’] è‡ªåŠ¨è·å–rootfs" --yes-button "yes" --no-button "no" --yesno "è‡ªåŠ¨è·å–rootfsä¸‹è½½é“¾æ¥?" 7 $WIDTH;then
    AUTO_GET_LINK=y
  else
    AUTO_GET_LINK=n
  fi
  if [[ ${AUTO_GET_LINK} = "n" ]];then
    whiptail --title "[ï™] å¸®åŠ©ä¿¡æ¯" --msgbox "ä½ å¯ä»¥å» http://mirrors.tuna.tsinghua.edu.cn/lxc-images/images å»è·å–rootfsä¸‹è½½é“¾æ¥æˆ–ä½¿ç”¨è‡ªå®šä¹‰rootfs" 9 $WIDTH
    while :
    do
      LINK=$(whiptail --title "[îœ’] rootfs" --inputbox "è¯·è¾“å…¥rootfsä¸‹è½½é“¾æ¥æˆ–è€…è‡ªå®šä¹‰rootfsçš„ç»å¯¹è·¯å¾„:" 7 $WIDTH 3>&1 1>&2 2>&3)
      if [[ $LINK != "" ]];then
        break
      fi
    done
  fi
  rm -rf $PREFIX/tmp/container
  mkdir -p $PREFIX/tmp/container
  cd $PREFIX/tmp/container
  if [[ ${AUTO_GET_LINK} = "y" ]];then
    DOWNLOAD_ROOTFS
  else
    axel -n16 ${LINK}||cp ${LINK} ./||exit 0
  fi
  if ! mkdir -p ${CONTAINER_DIR};then
    whiptail --title "[ï‘¯] é”™è¯¯" --msgbox "æ— æ³•åˆ›å»ºå®¹å™¨ç›®å½•!" 7 $WIDTH
    rm -rf $PREFIX/tmp/container
    exit 1
  fi
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[ï£•] è§£å‹rootfs"|pv -qL 40
  sleep 1s
  ROOTFS=$(ls $PREFIX/tmp/container/)
  case $ROOTFS in
    *tar.gz|*tgz) pv $PREFIX/tmp/container/$ROOTFS|tar -xzf - -C ${CONTAINER_DIR};;
    *tar.xz|*txz) pv $PREFIX/tmp/container/$ROOTFS|tar -xJf - -C ${CONTAINER_DIR};;
    *tar) pv $PREFIX/tmp/container/$ROOTFS|tar -xf - -C ${CONTAINER_DIR};;
    *) whiptail --title "[ï‘¯] é”™è¯¯" --msgbox "æœªçŸ¥æ–‡ä»¶æ ¼å¼!" 7 $WIDTH;exit 1;;
  esac
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[ï’] åˆ é™¤å·²ä¸‹è½½çš„rootfs"|pv -qL 40
  rm -rf $PREFIX/tmp/container/
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[ï‘±] å†™å…¥é…ç½®æ–‡ä»¶"|pv -qL 40
  for i in {1..100};do
    if [[ ! -e $PREFIX/etc/container/container-${i}.conf ]];then
      CONTAINER=$i
      break
    fi
  done
  echo "#æ­¤æ–‡ä»¶ä¸ºtermux-containerè‡ªåŠ¨åˆ›å»º" >> $PREFIX/etc/container/container-${CONTAINER}.conf
  echo "#å¦‚æœä½ ä¸çŸ¥é“ä½ åœ¨å¹²ä»€ä¹ˆ,ä¸è¦ç¼–è¾‘æ­¤æ–‡ä»¶!" >> $PREFIX/etc/container/container-${CONTAINER}.conf
  echo RUN_MODE=proot >> $PREFIX/etc/container/container-${CONTAINER}.conf
  echo NAME=${NAME} >> $PREFIX/etc/container/container-${CONTAINER}.conf
  echo CONTAINER_DIR=${CONTAINER_DIR} >> $PREFIX/etc/container/container-${CONTAINER}.conf
  echo CROSS_ARCH=${CROSS_ARCH} >> $PREFIX/etc/container/container-${CONTAINER}.conf
  export NEW_CONTAINER=${CONTAINER}
  LOAD_GLOBAL_CONFIG
  export CONTAINER_BK=${CONTAINER}
  unset CONTAINER
  sed -i "s/CONTAINER=$CONTAINER_BK/CONTAINER=$NEW_CONTAINER/" $PREFIX/etc/container/global.conf
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[ï¥] ä¿®å¤ä¸­..."|pv -qL 40
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[ï ˜] ä¿®å¤dns"|pv -qL 40
  rm -f ${CONTAINER_DIR}/etc/resolv.conf
  echo nameserver 8.8.8.8 >> ${CONTAINER_DIR}/etc/resolv.conf
  echo nameserver 114.114.114.114 >> ${CONTAINER_DIR}/etc/resolv.conf
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "[ï”“] æ·»åŠ ç”¨æˆ·ç»„"|pv -qL 40
  cp $PREFIX/share/termux-container/group_add.sh ${CONTAINER_DIR}/tmp/
  chmod 777 ${CONTAINER_DIR}/tmp/group_add.sh
  if [[ ${NEW_USER} != "" && ${PASSWORD} != "" ]];then
    sed -i "s/NEW_USER=\"\"/NEW_USER=${NEW_USER}/" ${CONTAINER_DIR}/tmp/group_add.sh
    sed -i "s/PASSWORD=\"\"/PASSWORD=${PASSWORD}/" ${CONTAINER_DIR}/tmp/group_add.sh
  fi
  unset LD_PRELOAD
  COMMAND="proot --link2symlink --sysvipc -0 -r ${CONTAINER_DIR} -b /dev -b /sys -b /proc -w /root"
  if [[ ${CROSS_ARCH} != "null" ]];then
    COMMAND+=" -q qemu-${CROSS_ARCH}"
  fi
  ${COMMAND} /tmp/group_add.sh >> /dev/null 2>&1
  echo -e "[ï˜] åˆ›å»ºå®Œæ¯•!"
}
#ç©ºå£³ï¼Œä»…è¿›è¡Œè°ƒç”¨
#è¿™ç§åŸºæœ¬åªå‰©ç©ºå£³çš„å‡½æ•°å¹¶ä¸æ˜¯å¥½æ–‡æ˜ï¼Œä½†æ˜¯å¥½ç”¨å•Š
CREATE_CONTAINER(){
  LOAD_GLOBAL_CONFIG
  if whiptail --title "[ï¡š] é€‰æ‹©è¿è¡Œæ¨¡å¼" --yes-button "chroot-unshare" --no-button "proot"  --yesno "å¦‚æœä½ çš„æ‰‹æœºrootäº†ï¼Œå»ºè®®ä½¿ç”¨chroot-unshareæ¨¡å¼è¿è¡Œå®¹å™¨\nå¦‚æœä½ çš„æ‰‹æœºæ²¡æœ‰rootæˆ–è€…ä½ æƒ³è¿è¡Œè·¨æ¶æ„å®¹å™¨ï¼Œè¯·é€‰æ‹©proot\n\nè¯·é€‰æ‹©ä½ çš„è¿è¡Œæ¨¡å¼:" 12 $WIDTH;then
    sudo container -e CREATE_CHROOT_CONTAINER
  else
    CREATE_PROOT_CONTAINER
  fi
}
#chrootå®¹å™¨å¤‡ä»½ *æœªå……åˆ†æµ‹è¯•ç‰¹æ€§
BACKUP_CHROOT_CONTAINER(){
  pkill unshare
  source $PREFIX/etc/container/container-$1.conf
  umount -lvf ${CONTAINER_DIR}/dev >> /dev/null 2>&1
  umount -lvf ${CONTAINER_DIR}/sys >> /dev/null 2>&1
  umount -lvf ${CONTAINER_DIR}/proc >> /dev/null 2>&1
  umount ${CONTAINER_DIR}/sdcard >> /dev/null 2>&1
  umount -lvf ${CONTAINER_DIR} >> /dev/null 2>&1
  losetup -d ${CONTAINER_IMG} >> /dev/null 2>&1
  if [[ ${CONTAINER_IMG} != "" && ${CONTAINER_IMG} != "null" ]];then
    LOOPFILE=$(sudo losetup -f)
    sudo losetup ${LOOPFILE} ${CONTAINER_IMG}
    sudo mount ${LOOPFILE} ${CONTAINER_DIR}
    SIZE=$(($(du --block-size=1G ${CONTAINER_IMG}|awk '{print $1}')-1))
  fi
  echo -e "[ï] é€‰æ‹©å¤‡ä»½æ–‡ä»¶å‹ç¼©æ ¼å¼:"
  while :
  do
    read -p "[1]tar.gz [2]tar.xz [3]tar " FORMAT
    if [[ $FORMAT = "1" || $FORMAT = "2" || $FORMAT = "3" ]];then
      break
    fi
  done
  cd ${CONTAINER_DIR}
  rm -rf $PREFIX/tmp/container
  mkdir -p $PREFIX/tmp/container
  case ${FORMAT} in
    1) tar -zPpcvf $PREFIX/tmp/container/rootfs.tar.gz .;;
    2) tar -JPpcvf $PREFIX/tmp/container/rootfs.tar.xz .;;
    3) tar -Ppcvf  $PREFIX/tmp/container/rootfs.tar .;;
  esac
  cp $PREFIX/etc/container/container-$1.conf $PREFIX/tmp/container/container.conf
  cd $PREFIX/tmp/container
  if [[ ${SIZE} != "" ]];then
    echo IMG_SIZE=${SIZE} >> $PREFIX/tmp/container/container.conf
  fi
  TARGET="/sdcard/container-$NAME-$(date +%y%m%d%H%M%S).bk"
  tar -cvf ${TARGET} .
  rm -rf $PREFIX/tmp/container
  echo -e "[ï] å¤‡ä»½å®Œæˆ,å¤‡ä»½æ–‡ä»¶: ${TARGET}"
}
#prootå®¹å™¨å¤‡ä»½ *éœ€ä¿®å¤ç¡¬é“¾æ¥æƒé™
BACKUP_PROOT_CONTAINER(){
  pkill proot
  source $PREFIX/etc/container/container-$1.conf
  echo -e "[ï] é€‰æ‹©å¤‡ä»½æ–‡ä»¶å‹ç¼©æ ¼å¼:"
  while :
  do
    read -p "[1]tar.gz [2]tar.xz [3]tar " FORMAT
    if [[ $FORMAT = "1" || $FORMAT = "2" || $FORMAT = "3" ]];then
      break
    fi
  done
  cd ${CONTAINER_DIR}
  rm -rf $PREFIX/tmp/container
  mkdir -p $PREFIX/tmp/container
  case ${FORMAT} in
    1) tar -zPpcvf $PREFIX/tmp/container/rootfs.tar.gz .;;
    2) tar -JPpcvf $PREFIX/tmp/container/rootfs.tar.xz .;;
    3) tar -Ppcvf  $PREFIX/tmp/container/rootfs.tar .;;
  esac
  cp $PREFIX/etc/container/container-$1.conf $PREFIX/tmp/container/container.conf
  cd $PREFIX/tmp/container
  TARGET="/sdcard/container-$NAME-$(date +%y%m%d%H%M%S).bk"
  tar -cvf ${TARGET} .
  rm -rf $PREFIX/tmp/container
  echo -e "[ï] å¤‡ä»½å®Œæˆ,å¤‡ä»½æ–‡ä»¶: ${TARGET}"
}
#åˆä¸€ä¸ªç©ºå£³ï¼Œè·å–å®¹å™¨ä¿¡æ¯ç„¶åè°ƒç”¨ä¸Šè¾¹é‚£ä¸¤ä¸ªå‡½æ•°
#è¿™è¿˜æ˜¯é‡æ„è¿‡çš„ç»“æ„ï¼Œå¾ˆéš¾æƒ³è±¡è¿™ç§æ¶æ„æ˜¯æ€ä¹ˆè¢«è®¾è®¡å‡ºæ¥çš„
BACKUP_CONTAINER(){
  LOAD_GLOBAL_CONFIG
  [[ ${ENABLE_OUTPUT} = "false" ]]||clear
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($(stty size|awk '{print $2}')))
  [[ ${ENABLE_OUTPUT} = "false" ]]||let i1=$(($i1))
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($i1-16))
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[30;48;5;159mCONTAINER_BACKUP$(yes " "|sed $i1'q'|tr -d '\n')\033[0m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  cd $PREFIX/etc/container
  for i in {1..100};do
    if [[ -e container-${i}.conf ]];then
      source container-${i}.conf
      echo -e "[${i}] ${NAME} (${RUN_MODE})"
      sleep 0.1s
    fi
  done
  while :
  do
    read -p "[ïš¦] é€‰æ‹©è¦å¤‡ä»½çš„å®¹å™¨: " CONTAINER
    if [[ -e $PREFIX/etc/container/container-${CONTAINER}.conf ]];then
      break
    fi
  done
  source $PREFIX/etc/container/container-${CONTAINER}.conf
  if [[ ${RUN_MODE} = "chroot-unshare" ]];then
    sudo container -e BACKUP_CHROOT_CONTAINER ${CONTAINER}
  else
    BACKUP_PROOT_CONTAINER ${CONTAINER}
  fi
}
#å®¹å™¨è¿˜åŸ *æœªå……åˆ†æµ‹è¯•ç‰¹æ€§
RESTORE_CONTAINER(){
  LOAD_GLOBAL_CONFIG
  [[ ${ENABLE_OUTPUT} = "false" ]]||clear
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($(stty size|awk '{print $2}')))
  [[ ${ENABLE_OUTPUT} = "false" ]]||let i1=$(($i1))
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($i1-17))
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[30;48;5;159mCONTAINER_RESTORE$(yes " "|sed $i1'q'|tr -d '\n')\033[0m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 1s
  echo -e "[ï£•] è§£å‹æ¢å¤åŒ…"
  rm -rf $PREFIX/tmp/container
  mkdir -p $PREFIX/tmp/container
  pv $1|tar -xf - -C $PREFIX/tmp/container
  source $PREFIX/tmp/container/container.conf
  echo -e "[ï£•] è§£å‹rootfs"
  if [[ ${RUN_MODE} = "chroot-unshare" ]];then
    sudo mkdir -p ${CONTAINER_DIR}
    if [[ ${IMG_SIZE} != "" ]];then
      sudo dd if=/dev/zero of=${CONTAINER_IMG} bs=1G count=${IMG_SIZE}
      sudo mkfs.ext4 ${CONTAINER_IMG}
      LOOPFILE=$(sudo losetup -f)
      sudo losetup ${LOOPFILE} ${CONTAINER_IMG}
      sudo mount ${LOOPFILE} ${CONTAINER_DIR}
    fi
    ROOTFS=$(ls $PREFIX/tmp/container/rootfs*)
    case ${ROOTFS} in
      *tar)sudo bash -c "pv ${ROOTFS}|tar -Ppxf - -C ${CONTAINER_DIR}";;
      *tar.gz)sudo bash -c "pv ${ROOTFS}|tar -Ppxzf - -C ${CONTAINER_DIR}";;
      *tar.xz)sudo bash -c "pv ${ROOTFS}|tar -xPpJf - -C ${CONTAINER_DIR}";;
    esac
  else
    mkdir -p ${CONTAINER_DIR}
    ROOTFS=$(ls $PREFIX/tmp/container/rootfs*)
    case ${ROOTFS} in
      *tar) pv ${ROOTFS}|tar -xPpf - -C ${CONTAINER_DIR};;
      *tar.gz) pv ${ROOTFS}|tar -xPpzf - -C ${CONTAINER_DIR};;
      *tar.xz) pv ${ROOTFS}|tar -xJPpf - -C ${CONTAINER_DIR};;
    esac
  fi
  echo -e "\e[38;5;159m[ï‘±] å†™å…¥é…ç½®æ–‡ä»¶"
  for i in {1..100};do
    if [[ ! -e $PREFIX/etc/container/container-$i.conf ]];then
      mv $PREFIX/tmp/container/container.conf $PREFIX/etc/container/container-$i.conf
      sed -i "s/CONTAINER=$CONTAINER/CONTAINER=$i/" $PREFIX/etc/container/global.conf
      break
    fi
  done
  rm -rf $PREFIX/tmp/container
}
#å®¹å™¨åˆ‡æ¢ï¼Œswitchå‡†ç¡®ä¸å‡†ç¡®æˆ‘ä¹Ÿä¸çŸ¥é“
#åç»­æ›´æ–°ä¸€å®šç§»é™¤
SWITCH_CONTAINER(){
  LOAD_GLOBAL_CONFIG
  [[ ${ENABLE_OUTPUT} = "false" ]]||clear
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($(stty size|awk '{print $2}')))
  [[ ${ENABLE_OUTPUT} = "false" ]]||let i1=$(($i1))
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($i1-16))
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[30;48;5;159mCONTAINER_SWITCH$(yes " "|sed $i1'q'|tr -d '\n')\033[0m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  cd $PREFIX/etc/container
  for i in {1..100};do
    if [[ -e container-${i}.conf ]];then
      source container-${i}.conf
      echo -e "\e[38;5;159m[$i] ${NAME} (${RUN_MODE})"
    fi
  done
  #å˜é‡CONTAINERç”±LOAD_GLOBAL_CONFIGåˆ›å»º
  #å½“æ—¶åˆšæ¥è§¦shellæ²¡å¤šä¹…ï¼Œæ ¹æœ¬ä¸ä¼šç”¨æ­£åˆ™ï¼Œsedéƒ½æ˜¯ä¸ºäº†å®Œæˆè¿™ä¸ªåŠŸèƒ½ç°å­¦çš„    +  #å½“æ—¶æˆ‘å±…ç„¶ç”¨export $(cat /path/to/configfile)æ¥åŠ è½½é…ç½®ï¼Œç°åœ¨æƒ³æ¥ç¡®å®æœ‰ç‚¹å‚»
  #äº‹å®ä¸Š[0-9]*å°±èƒ½åŒ¹é…å®¹å™¨ç¼–å·ï¼Œæ ¹æœ¬ç”¨ä¸åˆ°è·å–åŸæ¥çš„å€¼
  #æ£€æŸ¥ä»£ç æ—¶è€è§‰å¾—è¿™ä¸ªå˜é‡ä¸å¯¹ï¼Œè¿˜ä»¥ä¸ºæ˜¯ä»å…¶ä»–å‡½æ•°ç§»æ¤è¿‡æ¥æ—¶å¿˜äº†åˆ ğŸ¤£ğŸ‘‰
  #å¹¸å¥½æ²¡åˆ ï¼Œè¦ä¸ç„¶å‡†å¾—å¯„
  export CONTAINER_BK=${CONTAINER}
  unset CONTAINER
  while :
  do
    read -p "[ïš¦] é€‰æ‹©è¦è¿è¡Œçš„å®¹å™¨: " CONTAINER
    if [[ -e $PREFIX/etc/container/container-${CONTAINER}.conf ]];then
      source $PREFIX/etc/termux-container/container-${CONTAINER_BK}.conf >> /dev/null 2>&1
      if [[ ${RUN_MODE} = "chroot-unshare" ]];then
        sudo umount -lvf ${CONTAINER_DIR}/dev >> /dev/null 2>&1
        sudo umount -lvf ${CONTAINER_DIR}/sys >> /dev/null 2>&1
        sudo umount -lvf ${CONTAINER_DIR}/proc >> /dev/null 2>&1
        sudo umount ${CONTAINER_DIR}/sdcard >> /dev/null 2>&1
        sudo umount -lvf ${CONTAINER_DIR} >> /dev/null 2>&1
        sudo losetup -d ${CONTAINER_IMG} >> /dev/null 2>&1
      fi
      break
    fi
  done
  sed -i "s/CONTAINER=$CONTAINER_BK/CONTAINER=$CONTAINER/" $PREFIX/etc/container/global.conf
  return 0
  exit 0
}
#åç»­æ›´æ–°ä¸€å®šç äº†
#è‡ªä»å‡ºæ¥å°±æ²¡ç”¨è¿‡è¿™åŠŸèƒ½ï¼Œè¿˜å¾—ä¸“é—¨æµ‹è¯•bugçƒ¦æ­»äº†
#ç»å¯¹æ˜¯å±å±±é—ç•™
MOUNT_IMAGE_FILE(){
  if [[ $(whoami) != "root" ]];then
    sudo container -e MOUNT_IMAGE_FILE
    exit 0
  fi
  LOAD_GLOBAL_CONFIG
  LOAD_CONTAINER_CONFIG
  [[ ${ENABLE_OUTPUT} = "false" ]]||clear
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($(stty size|awk '{print $2}')))
  [[ ${ENABLE_OUTPUT} = "false" ]]||let i1=$(($i1))
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($i1-15))
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[30;48;5;159mCONTAINER_MOUNT$(yes " "|sed $i1'q'|tr -d '\n')\033[0m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  if [[ ${CONTAINER_IMG} = "" ]];then
    echo -e "\a\033[31m[ï‘¯] é”™è¯¯:æœªä½¿ç”¨é•œåƒæ–‡ä»¶!\033[0m"
    exit 1
  fi
  if [[ ! -e ${CONTAINER_IMG} ]];then
    echo -e "\a\033[31m[ï‘¯] é”™è¯¯:é•œåƒæ–‡ä»¶ä¸å­˜åœ¨!\033[0m"
    exit 1
  fi
  LOOPFILE=$(sudo losetup -f)
  sudo losetup ${LOOPFILE} ${CONTAINER_IMG}
  sudo mount ${LOOPFILE} ${CONTAINER_DIR}
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[ïŸ¼] ${CONTAINER_IMG} å·²è¢«æŒ‚è½½åˆ° ${CONTAINER_DIR} \033[0m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[ïŸ¼] å®Œæ¯•!\033[0m"
  return 0
  exit 0
}
#äº‹å®ä¸Šåº”è¯¥å«chroot-unshare container
#åˆä¸€ä¸ªåˆ†ä½“å¼è®¾è®¡ï¼Œå¦ä¸€éƒ¨åˆ†ç”¨äºåˆå§‹åŒ–ç³»ç»Ÿï¼Œä½äºå®¹å™¨å†…ï¼Œè¢«unshare forkå‡ºæ¥å•ç‹¬çš„è¿›ç¨‹æ‰§è¡Œ
RUN_CHROOT_CONTAINER(){
  LOAD_GLOBAL_CONFIG
  LOAD_CONTAINER_CONFIG
  [[ ${ENABLE_OUTPUT} = "false" ]]||clear
  [[ ${ENABLE_OUTPUT} = "false" ]]||printf '\e[38;5;159m\033[?25l'
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($(stty size|awk '{print $2}')))
  [[ ${ENABLE_OUTPUT} = "false" ]]||let i1=$(($i1))
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($i1-13))
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[30;48;5;159mCONTAINER_RUN$(yes " "|sed $i1'q'|tr -d '\n')\033[0m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m    _________      [\e[38;5;153mïš¦\e[38;5;159m] å®¹å™¨å: \e[38;5;153m${NAME}"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m   /        /\\     [\e[38;5;153mï¡š\e[38;5;159m] CPUæ¶æ„: \e[38;5;153m$(uname -m)"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  if [[ $DISABLE_SELINUX = "true" ]];then
    SELINUX=Permissive
  else
    SELINUX=Enforcing
  fi
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m  /        /  \\    [\e[38;5;153mï’œ\e[38;5;159m] SELinuxçŠ¶æ€: \e[38;5;153m${SELINUX}"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m /        /    \\   [\e[38;5;153mîœ’\e[38;5;159m] å†…æ ¸ç‰ˆæœ¬: \e[38;5;153m$(uname -r)"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m/________/      \\  [\e[38;5;153mï€—\e[38;5;159m] å½“å‰æ—¶é—´: \e[38;5;153m$(date|awk '{print $4}')"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m\\        \\      /  [\e[38;5;153mï›ƒ\e[38;5;159m] ä¸»æœºå: \e[38;5;153m$(hostname)"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m \\        \\    /   [\e[38;5;153mîœ\e[38;5;159m] å®‰å“ç‰ˆæœ¬: \e[38;5;153m$(getprop ro.build.version.release)"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m  \\        \\  /    [\e[38;5;153mï“\e[38;5;159m] å®¹å™¨ç›®å½•: \e[38;5;153m${CONTAINER_DIR}"
  if [[ $CONTAINER_IMG != "" ]];then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m   \\________\\/     [\e[38;5;153mî‰±\e[38;5;159m] å®¹å™¨é•œåƒ: \e[38;5;153m${CONTAINER_IMG}"
  else
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m   \\________\\/     [\e[38;5;153mî‰±\e[38;5;159m] å®¹å™¨é•œåƒ: \e[38;5;153mnull"
  fi
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159mã€‰\e[38;5;153mTERMUX-CONTAINER"
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($(stty size|awk '{print $2}')))
  [[ ${ENABLE_OUTPUT} = "false" ]]||let i1=$(($i1))
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m$(yes "â”€"|sed $i1'q'|tr -d '\n')"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "//////"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  if [[ ! -e ${CONTAINER_DIR} ]];then
    echo -e "\033[31m\a[ï‘¯] é”™è¯¯:å®¹å™¨ç›®å½•ä¸å­˜åœ¨!"&&printf "\033[?25h"
    exit 1
  fi
  if [[ ${CONTAINER_IMG} != "" && ${CONTAINER_IMG} != "null" ]] && [[ ! -e ${CONTAINER_IMG} ]];then
    echo -e "\a\033[31m[ï‘¯] é”™è¯¯:é•œåƒæ–‡ä»¶ä¸å­˜åœ¨!"&&printf "\033[?25h"
    exit 1
  fi
  if [[ ${DISABLE_SELINUX} = "true" ]];then
    if [[ $(getenforce) != "Permissive" ]];then
      [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] å…³é—­ SELinux"
      [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
      setenforce 0 >> /dev/null 2>&1
    fi
  fi
  if [[ $(mount|grep ${CONTAINER_DIR}) =  "" ]];then
    if [[ ${CONTAINER_IMG} = "" || ${CONTAINER_IMG} = "null" ]];then
      [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] é‡æŒ‚è½½ /data"
      [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
      mount -o remount,suid /data  >> /dev/null 2>&1
      [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] æŒ‚è½½ ${CONTAINER_DIR}"
      [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
      mount --rbind ${CONTAINER_DIR} ${CONTAINER_DIR} >> /dev/null 2>&1
    else
      [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] è¿è¡Œ fsck"
      fsck.ext4 -a -f  ${CONTAINER_IMG} >> /dev/null 2>&1
      [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] æŒ‚è½½ ${CONTAINER_IMG}"
      [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
      LOOPFILE=$(losetup -f)
      losetup  ${LOOPFILE} ${CONTAINER_IMG}  >> /dev/null 2>&1
      mount  ${LOOPFILE} ${CONTAINER_DIR}  >> /dev/null 2>&1
    fi
  fi
  if [[ $(mount|grep ${CONTAINER_DIR}|grep /sdcard) =  "" && ${MOUNT_SDCARD} = "true" ]];then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] æŒ‚è½½ /sdacrd"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    mount -o ro,bind /sdcard ${CONTAINER_DIR}/sdcard/ >> /dev/null 2>&1
  fi
  case $CURSOR in
    block)     printf '\e[2 q';;
    bar)       printf '\e[6 q';;
    underline) printf '\e[4 q';;
  esac
  if [[ ! -e ${CONTAINER_DIR}/usr/local/bin/unshare_init ]];then
    mkdir -p ${CONTAINER_DIR}/usr/local/bin/ >> /dev/null 2>&1
    cp $PREFIX/share/termux-container/unshare_init ${CONTAINER_DIR}/usr/local/bin/
    chmod 777 ${CONTAINER_DIR}/usr/local/bin/unshare_init
  fi
  [[ ${ENABLE_OUTPUT} = "false" ]]||touch ${CONTAINER_DIR}/etc/enable_output
  [[ ${ENABLE_OUTPUT} = "true" ]]||rm ${CONTAINER_DIR}/etc/enable_output >> /dev/null 2>&1
  echo ${HOSTNAME} > ${CONTAINER_DIR}/etc/hostname
  UNSHARE_PARAMETER="--fork"
  if [[ -e  /proc/$$/ns/ipc ]];then
    UNSHARE_PARAMETER+=" -i"
  fi
  if [[ -e /proc/$$/ns/mnt ]];then
    UNSHARE_PARAMETER+=" -m"
  fi
  if [[ -e /proc/$$/ns/pid ]];then
    UNSHARE_PARAMETER+=" -p"
  fi
  if [[ -e /proc/$$/ns/uts ]];then
    UNSHARE_PARAMETER+=" -u"
  fi
  printf "\033[?25h\033[0m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] è¿è¡Œ unshare"
  unset LD_PRELOAD
  /bin/unshare ${UNSHARE_PARAMETER} $PREFIX/bin/chroot ${CONTAINER_DIR} /usr/local/bin/unshare_init
  printf '\e[2 q\033[0m'
  return 0
  exit 0
}
#è¿™ä¸ªç©ºå£³ç®€ç›´æ˜¯è„‘æº¢è¡€è®¾è®¡
#æ€•æ˜¯çŠ¯ç€å›°å†™çš„
LEGACY_MODE(){
  LOAD_GLOBAL_CONFIG
  LOAD_CONTAINER_CONFIG
  if [[ ${RUN_MODE} = "proot" ]];then
    echo -e "\a\033[31m[ï‘¯] é”™è¯¯:ä¼ ç»Ÿæ¨¡å¼ä»…ä¾›chrootå®¹å™¨ä½¿ç”¨!"
    exit 1
  fi
  sudo container -e RUN_CHROOT_CONTAINER_LEGACY_MODE
  return 0
  exit 0
}
#è¿™æ®µå¿…é¡»åœ¨rootä¸‹æ‰§è¡Œ
#ç¡®å®æŒºè‰
RUN_CHROOT_CONTAINER_LEGACY_MODE(){
  LOAD_GLOBAL_CONFIG
  LOAD_CONTAINER_CONFIG
  [[ ${ENABLE_OUTPUT} = "false" ]]||clear
  [[ ${ENABLE_OUTPUT} = "false" ]]||printf '\e[38;5;159m\033[?25l'
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($(stty size|awk '{print $2}')))
  [[ ${ENABLE_OUTPUT} = "false" ]]||let i1=$(($i1))
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($i1-13))
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[30;48;5;159mCONTAINER_RUN$(yes " "|sed $i1'q'|tr -d '\n')\033[0m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m    _________      [\e[38;5;153mïš¦\e[38;5;159m] å®¹å™¨å: \e[38;5;153m${NAME}"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m   /        /\\     [\e[38;5;153mï¡š\e[38;5;159m] CPUæ¶æ„: \e[38;5;153m$(uname -m)"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  if [[ $DISABLE_SELINUX = "true" ]];then
    SELINUX=Permissive
  else
    SELINUX=Enforcing
  fi
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m  /        /  \\    [\e[38;5;153mï’œ\e[38;5;159m] SELinuxçŠ¶æ€: \e[38;5;153m${SELINUX}"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m /        /    \\   [\e[38;5;153mîœ’\e[38;5;159m] å†…æ ¸ç‰ˆæœ¬: \e[38;5;153m$(uname -r)"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m/________/      \\  [\e[38;5;153mï€—\e[38;5;159m] å½“å‰æ—¶é—´: \e[38;5;153m$(date|awk '{print $4}')"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m\\        \\      /  [\e[38;5;153mï›ƒ\e[38;5;159m] ä¸»æœºå: \e[38;5;153m$(hostname)"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m \\        \\    /   [\e[38;5;153mîœ\e[38;5;159m] å®‰å“ç‰ˆæœ¬: \e[38;5;153m$(getprop ro.build.version.release)"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m  \\        \\  /    [\e[38;5;153mï“\e[38;5;159m] å®¹å™¨ç›®å½•: \e[38;5;153m${CONTAINER_DIR}"
  if [[ $CONTAINER_IMG != "" ]];then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m   \\________\\/     [\e[38;5;153mî‰±\e[38;5;159m] å®¹å™¨é•œåƒ: \e[38;5;153m${CONTAINER_IMG}"
  else
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m   \\________\\/     [\e[38;5;153mî‰±\e[38;5;159m] å®¹å™¨é•œåƒ: \e[38;5;153mnull"
  fi
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159mã€‰\e[38;5;153mTERMUX-CONTAINER"
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($(stty size|awk '{print $2}')))
  [[ ${ENABLE_OUTPUT} = "false" ]]||let i1=$(($i1))
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m$(yes "â”€"|sed $i1'q'|tr -d '\n')"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "//////"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  if [[ ! -e ${CONTAINER_DIR} ]];then
    echo -e "\033[31m\a[ï‘¯] é”™è¯¯:å®¹å™¨ç›®å½•ä¸å­˜åœ¨!"&&printf "\033[?25h"
    exit 1
  fi
  if [[ ${CONTAINER_IMG} != "" && ${CONTAINER_IMG} != "null" ]] && [[ ! -e ${CONTAINER_IMG} ]];then
    echo -e "\a\033[31m[ï‘¯] é”™è¯¯:é•œåƒæ–‡ä»¶ä¸å­˜åœ¨!"&&printf "\033[?25h"
    exit 1
  fi
  if [[ ${DISABLE_SELINUX} = "true" ]];then
    if [[ $(getenforce) != "Permissive" ]];then
      [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] å…³é—­ SELinux"
      [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
      setenforce 0 >> /dev/null 2>&1
    fi
  fi
  if [[ $(mount|grep ${CONTAINER_DIR}) =  "" ]];then
    if [[ ${CONTAINER_IMG} = "" || ${CONTAINER_IMG} = "null" ]];then
      [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] é‡æŒ‚è½½ /data"
      [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
      mount -o remount,suid /data  >> /dev/null 2>&1
      [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] æŒ‚è½½ ${CONTAINER_DIR}"
      [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
      mount --rbind ${CONTAINER_DIR} ${CONTAINER_DIR} >> /dev/null 2>&1
    else
      [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] è¿è¡Œ fsck"
      fsck.ext4 -a -f  ${CONTAINER_IMG} >> /dev/null 2>&1
      [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] æŒ‚è½½ ${CONTAINER_IMG}"
      [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
      LOOPFILE=$(losetup -f)
      losetup  ${LOOPFILE} ${CONTAINER_IMG}  >> /dev/null 2>&1
      mount  ${LOOPFILE} ${CONTAINER_DIR}  >> /dev/null 2>&1
    fi
  fi
  if [[ $(mount|grep ${CONTAINER_DIR}|grep /sdcard) =  "" && ${MOUNT_SDCARD} = "true" ]];then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] æŒ‚è½½ /sdacrd"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    mount -o ro,bind /sdcard ${CONTAINER_DIR}/sdcard/ >> /dev/null 2>&1
  fi
  if [[ ! -e /dev/fd ]];then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] åˆ›å»º /dev/fd"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    ln -s /proc/self/fd /dev/ >> /dev/null 2>&1
  fi
  if [[ ! -e /dev/stdin ]];then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] åˆ›å»º /dev/stdin"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    ln -s /proc/self/fd/0 /dev/stdin >> /dev/null 2>&1
  fi
  if [[ ! -e /dev/stdout ]];then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] åˆ›å»º /dev/stdout"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    ln -s /proc/self/fd/1 /dev/stdout >> /dev/null 2>&1
  fi
  if [[ ! -e /dev/stderr ]];then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] åˆ›å»º /dev/stderr"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    ln -s /proc/self/fd/2 /dev/stderr >> /dev/null 2>&1
  fi
  if [[ ! -e /dev/tty0 ]];then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] åˆ›å»º /dev/tty0"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    ln -s /dev/null /dev/tty0 >> /dev/null 2>&1
  fi
  if [[ ! -e "/dev/net/tun" ]];then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] åˆ›å»º /dev/net/tun"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    [[ -d /dev/net ]] || mkdir -p /dev/net >> /dev/null 2>&1
    mknod /dev/net/tun c 10 200 >> /dev/null 2>&1
  fi
  if [[ ! -e /dev/shm ]];then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] åˆ›å»º /dev/shm"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    mkdir -p /dev/shm >> /dev/null 2>&1
    mount -o rw,nosuid,nodev,mode=1777 -t tmpfs tmpfs /dev/shm >> /dev/null 2>&1
  fi
  if ! mountpoint -q ${CONTAINER_DIR}/proc;then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] æŒ‚è½½ /proc"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    mount --bind /proc ${CONTAINER_DIR}/proc >> /dev/null 2>&1
  fi
  if ! mountpoint -q ${CONTAINER_DIR}/sys;then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] æŒ‚è½½ /sys"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    mount --bind /sys ${CONTAINER_DIR}/sys >> /dev/null 2>&1
  fi
  if ! mountpoint -q ${CONTAINER_DIR}/dev;then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] æŒ‚è½½ /dev"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    mount --bind /dev ${CONTAINER_DIR}/dev >> /dev/null 2>&1
  fi
  if ! mountpoint -q ${CONTAINER_DIR}/dev/shm;then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] æŒ‚è½½ /dev/shm"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    mount -o bind /dev/shm ${CONTAINER_DIR}/dev/shm >> /dev/null 2>&1
  fi
  if ! mountpoint -q ${CONTAINER_DIR}/dev/pts;then
    [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] æŒ‚è½½ /dev/pts"
    [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
    mount -o bind /dev/pts ${CONTAINER_DIR}/dev/pts >> /dev/null 2>&1
  fi
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m[\e[38;5;158mï’‰\e[38;5;159m] è¿è¡Œå®¹å™¨"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  case ${CURSOR} in
    block)     printf '\e[2 q';;
    bar)       printf '\e[6 q';;
    underline) printf '\e[4 q';;
  esac
  printf "\033[?25h\033[0m"
  unset LD_PRELOAD
  chroot ${CONTAINER_DIR} /bin/su - root
}
#å¥½å”‰ï¼Œæ˜¯rootlesså®¹å™¨ï¼
RUN_PROOT_CONTAINER(){
  [[ ${ENABLE_OUTPUT} = "false" ]]||clear
  [[ ${ENABLE_OUTPUT} = "false" ]]||printf '\e[38;5;159m\033[?25l'
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($(stty size|awk '{print $2}')))
  [[ ${ENABLE_OUTPUT} = "false" ]]||let i1=$(($i1))
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($i1-13))
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[30;48;5;159mCONTAINER_RUN$(yes " "|sed $i1'q'|tr -d '\n')\033[0m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m    _________      [\e[38;5;153mïš¦\e[38;5;159m] å®¹å™¨å: \e[38;5;153m${NAME}"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m   /        /\\     [\e[38;5;153mï¡š\e[38;5;159m] CPUæ¶æ„: \e[38;5;153m$(uname -m)"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m  /        /  \\    [\e[38;5;153mï¡š\e[38;5;159m] è·¨æ¶æ„: \e[38;5;153m${CROSS_ARCH}"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m /        /    \\   [\e[38;5;153mîœ’\e[38;5;159m] å†…æ ¸ç‰ˆæœ¬: \e[38;5;153m$(uname -r)"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m/________/      \\  [\e[38;5;153mï€—\e[38;5;159m] å½“å‰æ—¶é—´: \e[38;5;153m$(date|awk '{print $4}')"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m\\        \\      /  [\e[38;5;153mï›ƒ\e[38;5;159m] ä¸»æœºå: \e[38;5;153m$(hostname)"
  [[ ${ENABLE_OUTPUT} = "false" ]]||sleep 0.1s
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m \\        \\    /   [\e[38;5;153mîœ\e[38;5;159m] å®‰å“ç‰ˆæœ¬: \e[38;5;153m$(getprop ro.build.version.release)"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m  \\        \\  /    [\e[38;5;153mï“\e[38;5;159m] å®¹å™¨ç›®å½•: \e[38;5;153m${CONTAINER_DIR}"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m   \\________\\/     [\e[38;5;153mïŸ¼\e[38;5;159m] å½“å‰ç‰ˆæœ¬: \e[38;5;153m8.1-nya"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159mã€‰\e[38;5;153mTERMUX-CONTAINER"
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($(stty size|awk '{print $2}')))
  [[ ${ENABLE_OUTPUT} = "false" ]]||let i1=$(($i1))
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m$(yes "â”€"|sed $i1'q'|tr -d '\n')"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "//////"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  unset LD_PRELOAD
  COMMAND="proot"
  COMMAND+=" --link2symlink"
  COMMAND+=" --kill-on-exit"
  COMMAND+=" --sysvipc"
  COMMAND+=" -0"
  COMMAND+=" -r ${CONTAINER_DIR}"
  COMMAND+=" -b /dev"
  COMMAND+=" -b /sys"
  COMMAND+=" -b /proc"
  COMMAND+=" -w /root"
  if [[ ${MOUNT_SDCARD} = "true" ]];then
    COMMAND+=" -b /sdcard"
  fi
  if [[ ${CROSS_ARCH} != "null" ]];then
    COMMAND+=" -q qemu-${CROSS_ARCH}"
  fi
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/buddyinfo:/proc/buddyinfo"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/cgroups:/proc/cgroups"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/consoles:/proc/consoles"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/crypto:/proc/crypto"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/devices:/proc/devices"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/diskstats:/proc/diskstats"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/execdomains:/proc/execdomains"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/fb:/proc/fb"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/filesystems:/proc/filesystems"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/interrupts:/proc/interrupts"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/iomem:/proc/iomem"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/ioports:/proc/ioports"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/kallsyms:/proc/kallsyms"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/key-users:/proc/key-users"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/keys:/proc/keys"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/kpageflags:/proc/kpageflags"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/loadavg:/proc/loadavg"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/locks:/proc/locks"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/misc:/proc/misc"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/modules:/proc/modules"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/pagetypeinfo:/proc/pagetypeinfo"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/partitions:/proc/partitions"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/sched_debug:/proc/sched_debug"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/softirqs:/proc/softirqs"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/stat:/proc/stat"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/timer_list:/proc/timer_list"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/uptime:/proc/uptime"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/version:/proc/version"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/vmallocinfo:/proc/vmallocinfo"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/vmstat:/proc/vmstat"
  COMMAND+=" --mount=$PREFIX/share/termux-container/proc/zoneinfo:/proc/zoneinfo"
  COMMAND+=" /bin/su - root"
  case ${CURSOR} in
    block)     printf '\e[2 q';;
    bar)       printf '\e[6 q';;
    underline) printf '\e[4 q';;
  esac
  printf "\033[?25h\033[0m"
  ${COMMAND}
  printf '\e[2 q'
  return 0
  exit 0
}
#å¥½å§ï¼Œè¿™ä¸ªè„šæœ¬ç©¶ç«Ÿä¼šè¢«é‡å¤æ‰§è¡Œå‡ æ¬¡è¿™ä¸ªé—®é¢˜ï¼Œåœ¨æˆ‘å†™çš„æ—¶å€™æˆ‘å’Œä¸Šå¸çŸ¥é“ï¼Œç°åœ¨åªæœ‰ä¸Šå¸çŸ¥é“äº†
RUN_CONTAINER(){
  LOAD_GLOBAL_CONFIG
  LOAD_CONTAINER_CONFIG
  if [[ ${RUN_MODE} = "chroot-unshare" ]];then
    sudo container -e RUN_CHROOT_CONTAINER
  else
    RUN_PROOT_CONTAINER
  fi
}
#ç§»é™¤å®¹å™¨
#å®‰å…¨æ€§æœªç»å……åˆ†æµ‹è¯•ï¼Œä½†æœ¬äººæµ‹è¯•å’Œç½‘å‹åé¦ˆå‡æœªè§æ–‡ä»¶è¯¯åˆ 
REMOVE_CONTAINER(){
  LOAD_GLOBAL_CONFIG
  [[ ${ENABLE_OUTPUT} = "false" ]]||clear
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($(stty size|awk '{print $2}')))
  [[ ${ENABLE_OUTPUT} = "false" ]]||let i1=$(($i1))
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($i1-16))
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[30;48;5;159mCONTAINER_REMOVE$(yes " "|sed $i1'q'|tr -d '\n')\033[0m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  cd $PREFIX/etc/container
  for i in {1..100};do
    if [[ -e container-${i}.conf ]];then
      source container-${i}.conf
      echo -e "[$i] $NAME (${RUN_MODE})"
    fi
  done
  while :
  do
    read -p "[ïš¦] é€‰æ‹©è¦åˆ é™¤çš„å®¹å™¨: " CONTAINER
    if [[ -e $PREFIX/etc/container/container-${CONTAINER}.conf ]];then
      break
     fi
  done
  echo -e "\a[ï”¥] å®¹å™¨ä¸­æ‰€æœ‰æ–‡ä»¶å°†è¢«åˆ é™¤"|pv -qL 40
  read -p "[ï”¥] æŒ‰å›è½¦é”®ç»§ç»­æˆ–æŒ‰ctrl-cé€€å‡º" NULL
  source $PREFIX/etc/container/container-${CONTAINER}.conf
  if [[ ${RUN_MODE} = "proot" ]];then
    if [[ ${CONTAINER_DIR} != "" ]];then
      chown -R $(whoami) ${CONTAINER_DIR}
      chmod -R 777 ${CONTAINER_DIR}
      rm -rvf ${CONTAINER_DIR}
    fi
    rm -v $PREFIX/etc/container/container-${CONTAINER}.conf
  else
    if [[ ${CONTAINER_DIR} != "" ]];then
      sudo umount -lvf ${CONTAINER_DIR}/dev >> /dev/null 2>&1
      sudo umount -lvf ${CONTAINER_DIR}/sys >> /dev/null 2>&1
      sudo umount -lvf ${CONTAINER_DIR}/proc >> /dev/null 2>&1
      sudo umount ${CONTAINER_DIR}/sdcard >> /dev/null 2>&1
      sudo umount -lvf ${CONTAINER_DIR} >> /dev/null 2>&1
      sudo losetup -d ${CONTAINER_IMG} >> /dev/null 2>&1
      sudo rm -rvf ${CONTAINER_DIR}
    fi
    if [[ ${CONTAINER_IMG} != "" && ${CONTAINER_IMG} != "null" ]];then
      sudo rm -v ${CONTAINER_IMG}
    fi
    sudo rm -v $PREFIX/etc/container/container-${CONTAINER}.conf
  fi
}
#å¸è½½ç¨‹åºï¼Œè¿è„šæœ¬éƒ½çŸ¥é“å†™ä¸ªå¸è½½ç¨‹åºï¼ŒæŸäº›è½¯ä»¶è‡ªå·±ç»†å“
REMOVE_ALL_CONTAINERS_AND_UNINSTALL(){
  LOAD_GLOBAL_CONFIG
  [[ ${ENABLE_OUTPUT} = "false" ]]||clear
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($(stty size|awk '{print $2}')))
  [[ ${ENABLE_OUTPUT} = "false" ]]||let i1=$(($i1))
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($i1-19))
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[30;48;5;159mCONTAINER_UNINSTALL$(yes " "|sed $i1'q'|tr -d '\n')\033[0m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  cd $PREFIX/etc/container
  for i in {1..100};do
      if [[ -e container-${i}.conf ]];then
        source $PREFIX/etc/container/container-${i}.conf
        read -p "[ï’] åˆ é™¤å®¹å™¨ ${NAME}[y/n]? " REMOVE
        if [[ $REMOVE = "n" ]];then
          continue
        fi
        sleep 1s
        if [[ ${RUN_MODE} = "proot" ]];then
          if [[ ${CONTAINER_DIR} != "" ]];then
            rm -rvf ${CONTAINER_DIR}
            rm -v $PREFIX/etc/container/container-${i}.conf
          fi
        else
          if [[ ! ${CONTAINER_DIR} = "" ]];then
            sudo umount -lvf ${CONTAINER_DIR}/dev >> /dev/null 2>&1
            sudo umount -lvf ${CONTAINER_DIR}/sys >> /dev/null 2>&1
            sudo umount -lvf ${CONTAINER_DIR}/proc >> /dev/null 2>&1
            sudo umount ${CONTAINER_DIR}/sdcard >> /dev/null 2>&1
            sudo umount -lvf ${CONTAINER_DIR} >> /dev/null 2>&1
            sudo losetup -d ${CONTAINER_IMG} >> /dev/null 2>&1
            if [[ ${CONTAINER_DIR} != "" ]];then
              sudo rm -rfv ${CONTAINER_DIR}
            fi
            if [[ ${CONTAINER_IMG} != "" ]];then
              sudo rm -rfv ${CONTAINER_IMG}
            fi
            sudo rm -v $PREFIX/etc/container/container-${i}.conf
          fi
        fi
        unset REMOVE
      fi
  done
  apt purge termux-container
  echo -e "\e[38;5;159m[ï˜] å¸è½½å®Œæˆ!"
  return 0
  exit 0
}
#åç»­å¯èƒ½éœ€è¦æ„æ€ä¸€ä¸ªæ›´å¥½çš„å®ç°
SETTINGS(){
  LOAD_GLOBAL_CONFIG
  [[ ${ENABLE_OUTPUT} = "false" ]]||clear
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($(stty size|awk '{print $2}')))
  [[ ${ENABLE_OUTPUT} = "false" ]]||let i1=$(($i1))
  [[ ${ENABLE_OUTPUT} = "false" ]]||i1=$(($i1-18))
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[30;48;5;159mCONTAINER_SETTINGS$(yes " "|sed $i1'q'|tr -d '\n')\033[0m"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e "\e[38;5;159m//"
  [[ ${ENABLE_OUTPUT} = "false" ]]||echo -e ""
  echo -e "------SETTINGS------"
  echo -e "[ï’‰] å¯ç”¨è¾“å‡º:${ENABLE_OUTPUT}"
  echo -e "[ï’œ] æŒ‚è½½/sdcard:${MOUNT_SDCARD}"
  echo -e "[ï›ƒ] ä¸»æœºå:${HOSTNAME}"
  echo -e "[î¢] å…‰æ ‡:${CURSOR}"
  echo -e "[ï’œ] ç¦ç”¨selinux:${DISABLE_SELINUX}"
  echo -e "[ïš¦] å®¹å™¨ç¼–å·:${CONTAINER}"
  read -p "æŒ‰å›è½¦é”®ç¼–è¾‘æ–‡ä»¶æˆ–æŒ‰ctrl-cå–æ¶ˆ" NULL
  nano $PREFIX/etc/container/global.conf
  return 0
  exit 0
}
#å¸®åŠ©é¡µé¢
SHOW_HELPS(){
  echo -e "              \e[38;5;157mâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
  echo -e "              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”‚"
  echo -e "              â”‚ â”‚  \e[38;5;227mâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
  echo -e "              \e[38;5;157mâ”‚ â”‚  \e[38;5;227mâ”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”‚"
  echo -e "              \e[38;5;157mâ”‚ â”‚  \e[38;5;227mâ”‚ â”‚  \e[38;5;157mâ”‚ â”‚  \e[38;5;227mâ”‚ â”‚"
  echo -e "              \e[38;5;157mâ”‚ â””â”€â”€\e[38;5;227mâ”‚ â”‚\e[38;5;157mâ”€â”€â”˜ â”‚  \e[38;5;227mâ”‚ â”‚"
  echo -e "              \e[38;5;157mâ””â”€â”€â”€â”€\e[38;5;227mâ”‚ â”‚\e[38;5;157mâ”€â”€â”€â”€â”˜  \e[38;5;227mâ”‚ â”‚"
  echo -e "                   \e[38;5;227mâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚"
  echo -e "                   \e[38;5;227mâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
  echo -e "\e[38;5;153mâ•â•”â•â•”â•â•â•”â•â•‘â•”â•” â•‘ â•‘â•‘ â•‘  â•”â•â•â•”â•â•‘â•”â• â•â•”â•â•”â•â•‘â•â•”â• â•”â•â•â•”â•â•‘"
  echo -e " â•‘ â•”â•â•â•”â•”â•â•‘â•‘â•‘â•‘ â•‘ â• â•â•â•‘  â•‘ â•‘â•‘ â•‘ â•‘ â•”â•â•‘â•‘â•‘ â•‘â•”â•â•â•”â•”â•"
  echo -e " â• â•â•â•â• â•â•â•â•â•â•â•â• â•  â•â•â•â•â•â•â• â• â• â• â•â•â• â•â•â•â•â• â•"
  echo -e "\e[38;5;159m          ã€Œæ­¤è„šæœ¬æ²¡æœ‰è¶…çº§ç‰›åŠ›!ã€"
  echo -e "Usage:"
  echo -e " container                   #æ‰“å¼€èœå•"
  echo -e " container -run              #è¿è¡Œå®¹å™¨"
  echo -e " container -l                #è¿è¡Œå®¹å™¨(ä¼ ç»Ÿæ¨¡å¼) *ä»…ä¾›chrootå®¹å™¨"
  echo -e " container -c                #åˆ›å»ºä¸€ä¸ªæ–°å®¹å™¨"
  echo -e " container -S                #åˆ‡æ¢å®¹å™¨"
  echo -e " container -s                #è®¾ç½®"
  echo -e " container -r                #åˆ é™¤ä¸€ä¸ªå®¹å™¨"
  echo -e " container -m                #æŒ‚è½½é•œåƒæ–‡ä»¶ *ä»…ä¾›chrootå®¹å™¨"
  echo -e " container -bk               #å¤‡ä»½å®¹å™¨"
  echo -e " container -R [å¤‡ä»½æ–‡ä»¶]     #è¿˜åŸå®¹å™¨"
  echo -e " container -e [å‡½æ•°å]       #æ‰§è¡Œå†…ç½®å‡½æ•° *ä»…ä¾›è°ƒè¯•"
  echo -e " container -v                #ç‰ˆæœ¬ä¿¡æ¯"
  echo -e " container -U                #æ‰¹é‡åˆ é™¤å®¹å™¨&å¸è½½æ­¤è„šæœ¬"
  echo -e " container -h                #æ˜¾ç¤ºæ­¤é¡µé¢\033[0m"
  return 0
  exit 0
}
#ç®€ç›´ä¸èƒ½å†æ²¡ç”¨
DISPLAY_VERSION(){
  printf '\e[38;5;159m'
  echo -e "[ïŸ] (>_Ã—)"
  echo -e "[ï‰] é¡¹ç›®: termux-container"
  echo -e "[ï‘«] ä½œè€…: Moe-hacker"
  echo -e "[ï˜£] è®¸å¯è¯: APACHE-2.0"
  echo -e "[ï’•] æ­¤è„šæœ¬*æ— æ‹…ä¿*"
  echo -e '[ïŸ¼] ç‰ˆæœ¬: 8.1-nya\033[0m'
  return 0
  exit 0
}
#whiptailèœå•ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆäºŒæ¬¡è°ƒç”¨containeræˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œå°±å¥½åƒå‡½æ•°ç™½å®šä¹‰äº†ä¸€æ ·
MENU(){
  printf '\e[38;5;159m'
  WIDTH=$(($(stty size|awk '{print $2}')-4))
  OPTION=$(whiptail --title "termux-container" --menu "é€‰æ‹©ä½ çš„æ“ä½œ" 16 $WIDTH 9 \
  "1" "è¿è¡Œå®¹å™¨" \
  "2" "è¿è¡Œå®¹å™¨(ä¼ ç»Ÿæ¨¡å¼)" \
  "3" "åˆ›å»ºå®¹å™¨" \
  "4" "åˆ‡æ¢å®¹å™¨"  \
  "5" "å¤‡ä»½å®¹å™¨" \
  "6" "è¿˜åŸå®¹å™¨" \
  "7" "åˆ é™¤å®¹å™¨" \
  "8" "è®¾ç½®" \
  "9" "ç‰ˆæœ¬ä¿¡æ¯" \
  "10" "æ‰¹é‡åˆ é™¤å®¹å™¨&å¸è½½æ­¤è„šæœ¬" \
  "11" "å¸®åŠ©ä¿¡æ¯" \
  "12" "é€€å‡º" 3>&1 1>&2 2>&3)
  case $OPTION in
    "1") container -run;;
    "2") container -l;;
    "3") container -c;;
    "4") container -S;;
    "5") container -bk;;
    "6") read -p "å¤‡ä»½æ–‡ä»¶:" BKFILE&&container -R $BKFILE;;
    "7") container -r;;
    "8") container -s;;
    "9") container -v;;
    "10") container -U;;
    "11") container -h;;
    "12") exit;;
  esac
  return 0
  exit 0
}
#è°ƒè¯•æ¥å£
#è¯´å®è¯æˆ‘æœ¬äººä¹ŸåŸºæœ¬æ²¡ç”¨è¿‡
#ä½†æ˜¯éƒ¨åˆ†ææƒé è¿™ä¸ªæ¥å£å®ç°
#å…¸å‹çš„å±å±±
EXEC_FUNCTION(){
  $1 $2
}
#ä¸»å…¥å£ï¼Ÿç»ˆäºå¼€å§‹æ‰§è¡Œä¸€æ¡å‘½ä»¤äº†
case $1 in
  *run)    RUN_CONTAINER;;
  *l)      LEGACY_MODE;;
  *h)      SHOW_HELPS;;
  *s)      SETTINGS;;
  *c)      CREATE_CONTAINER;;
  *m)      MOUNT_IMAGE_FILE;;
  *r)      REMOVE_CONTAINER;;
  *R)      RESTORE_CONTAINER $2;;
  *bk)     BACKUP_CONTAINER;;
  *S)      SWITCH_CONTAINER;;
  *v)      DISPLAY_VERSION;;
  *U)      REMOVE_ALL_CONTAINERS_AND_UNINSTALL;;
  *e)      EXEC_FUNCTION $2 $3;;
  "")      MENU;;
   *)      SHOW_HELPS;;
esac
#copyright 2022 Moe-hacker (Author)
# â–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â•â•â•
#â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â•â•
#â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘
# â•šâ•â• â•šâ•â•  â•šâ•â•â•â•â•â•â•  â•šâ•â•â•â•â•â•  â•šâ•â•
