#!bash
prepare(){
	if [[ ! `whoami` = "root" ]];then
		echo -e '\033[32m[E]\033[31mPlease run the script with sudo.\033[0m'
		exit
	else
		echo -e '[i]Device is rooted.'
		export $(cat /data/data/com.termux/files/usr/etc/container.conf)
		if [[ ! -e ${CHROOT_DIR} ]];then
			echo -e ###
			sleep 0.3s
			exit
		else
			echo -e [i]chroot_dir is ${CHROOT_DIR}
		fi
	fi
}
prepare
run_chroot(){
    prepare_chroot(){
        if [[ ! -e /data/arch-arm64 ]];then
            echo -e '\033[32m[E]\033[31m错误:\033[35m/data/arch-arm64\033[31m不存在\033[0m'
            sleep 0.3s
            exit
        else
            echo -e '\033[32m[*]\033[34m正在关闭\033[35mselinux\033[0m'
            sleep 0.3s
            su -c "setenforce 0"
            echo -e '\033[32m[*]\033[34m正在将主机名设置为\033[35mArchlinux\033[0m'
            sleep 0.3s
            su -c "hostname Archlinux"
        fi
        return 0
    }
    mount_system(){
        if [[ ! -e /dev/fd || ! -e /dev/stdin || ! -e /dev/stdout || ! -e /dev/stderr ]];then
            [[ ! -e /dev/fd ]] || echo -e '\033[32m[*]\033[34m正在创建\033[35m/proc/self/fd\033[34m到\033[35m/dev/fd\033[34m的链接\033[0m' && sleep 0.3s && su -c "ln -s /proc/self/fd /dev/" >/dev/null 2>&1
            [[ ! -e /dev/stdin ]] || echo -e '\033[32m[*]\033[34m正在创建\033[35m/proc/self/fd/0\033[34m到\033[35m/dev/stdin\033[34m的链接\033[0m' && sleep 0.3s && su -c "ln -s /proc/self/fd/0 /dev/stdin " >/dev/null 2>&1
            [[ ! -e /dev/stdout ]] || echo -e '\033[32m[*]\033[34m正在创建\033[35m/proc/self/fd/1\033[34m到\033[35m/dev/stdout的链接\033[0m' && sleep 0.3s && su -c "ln -s /proc/self/fd/1 /dev/stdout" >/dev/null 2>&1
            [[ ! -e /dev/stderr ]] || echo -e '\033[32m[*]\033[34m正在创建\033[35m/proc/self/fd/2\033[34m到\033[35m/dev/stderr的链接\033[0m' && sleep 0.3s && su -c "ln -s /proc/self/fd/2 /dev/stderr" >/dev/null 2>&1
        fi
        if [[ ! -e /dev/tty0 ]];then
            echo -e '\033[32m[*]\033[34m正在创建\033[35m/dev/null\033[34m到\033[35m/dev/tty0\033[34m的链接\033[0m'
            sleep 0.3s
            su -c "ln -s /dev/null /dev/tty0" >/dev/null 2>&1
        fi
        if [[ ! -e /dev/net/tun ]];then
            [[ -d /dev/net ]] || echo -e '\033[32m[*]\033[34m正在创建文件夹\033[35m/dev/net\033[0m' && sleep 0.3s && su -c "mkdir -p /dev/net" >/dev/null 2>&1
            echo -e '\033[32m[*]\033[34m正在创建虚拟设备文件\033[35m/dev/net/tun\033[0m'
            su -c "mknod /dev/net/tun c 10 200 " >/dev/null 2>&1
        fi
        if [[ $(mount|grep /data/arch-arm64|grep block) == "" ]];then
            echo -e '\033[32m[*]\033[34m正在挂载系统自身'
            sleep 0.3s
            su -c "mount --bind /data/arch-arm64 /data/arch-arm64" >/dev/null 2>&1
            su -c "mount -o remount,rw,seclabel,suid /dev/block/by-name/userdata /data/arch-arm64"
        fi
        if [[ ! -e /data/arch-arm64/proc/cpuinfo ]];then
            echo -e '\033[32m[*]\033[34m正在挂载\033[35m/proc\033[0m'
            sleep 0.3s
            su -c "mount --bind /proc /data/arch-arm64/proc/" >/dev/null 2>&1
        fi
        if [[ ! -e /data/arch-arm64/dev/block ]];then
            echo -e '\033[32m[*]\033[34m正在挂载\033[35m/dev\033[0m'
            sleep 0.3s
            su -c "mount --bind /dev /data/arch-arm64/dev/" >/dev/null 2>&1
        fi
        if [[ ! -e /data/arch-arm64/sys/kernel ]];then
            echo -e '\033[32m[*]\033[34m正在挂载\033[35m/sys\033[0m'
            sleep 0.3s
            su -c "mount --bind /sys /data/arch-arm64/sys/" >/dev/null 2>&1
        fi
        echo -e '\033[32m[*]\033[34m正在创建文件夹\033[35m/dev/shm\033[0m'
        sleep 0.3s
        su -c "mkdir -p /dev/shm /data/arch-arm64/dev/shm" >/dev/null 2>&1
        echo -e '\033[32m[*]\033[34m正在挂载\033[35mtmpfs\033[0m'
        sleep 0.3s
        su -c "mount -o rw,nosuid,nodev,mode=1777 -t tmpfs tmpfs /dev/shm" >/dev/null 2>&1
        echo -e '\033[32m[*]\033[34m正在挂载\033[35m/dev/shm\033[0m'
        sleep 0.3s
        su -c "mount --bind /dev/shm /data/arch-arm64/dev/shm" >/dev/null 2>&1
        echo -e '\033[32m[*]\033[34m正在挂载\033[35m/dev/pts\033[0m'
        sleep 0.3s
        su -c "mount --bind /dev/pts /data/arch-arm64/dev/pts" >/dev/null 2>&1
        echo -e '\033[32m[*]\033[34m正在将\033[35m/dev/null\033[34m的权限修改为\033[35m666\033[0m'
        sleep 0.3s
        su -c "chmod 666 /dev/null" >/dev/null 2>&1
        return 0
    }
    chroot_system(){
        echo -e '\033[32m[*]\033[34m正在删除原有环境变量(部分)\033[0m'
        sleep 0.3s
        su -c "unset TMP TEMP TMPDIR LD_PRELOAD LD_DEBUG ZPFX ZSH_CACHE PATH"
        echo -e '\033[32m[*]\033[34m正在运行\033[35mchroot\033[0m'
        sleep 0.3s
        echo -e '\033[33m[i]\033[34mWelcome to Archlinux!\033[0m'
        echo -e '\033[34m『我萌故我在!』\033[0m'
        su -c "/bin/chroot /data/arch-arm64 /bin/su - root"
        return 0
    }
    if [[ -e /data/arch-arm64/proc/cpuinfo && -e /data/arch-arm64/dev/null && -e /data/arch-arm64/sys/kernel ]];then
        echo -e '\033[33m[i]\033[34m系统已挂载\033[0m'
        chroot_system
    else
        echo -e '\033[33m[i]\033[34m系统未被挂载\033[0m'
        prepare_chroot
        mount_system
        chroot_system
    fi
}
umount_system(){
    echo -e '\033[33m[i]\033[34m正在解除系统挂载\033[0m'
    sleep 0.3s
    echo -e '\033[32m[*]\033[34m正在解除\033[35m/dev\033[34m的挂载\033[0m'
    sleep 0.3s
    su -c "umount -lvf /data/arch-arm64/dev" >/dev/null 2>&1
    echo -e '\033[32m[*]\033[34m正在解除\033[35m/sys\033[34m挂载\033[0m'
    sleep 0.3s
    su -c "umount -lvf /data/arch-arm64/sys" >/dev/null 2>&1
    echo -e '\033[32m[*]\033[34m正在解除\033[35m/proc\033[34m挂载\033[0m'
    sleep 0.3s
    su -c "umount -lvf /data/arch-arm64/proc" >/dev/null 2>&1
    echo -e '\033[32m[*]\033[34m正在解除\033[35m/data/arch-arm64\033[34m挂载\033[0m'
    sleep 0.3s
    su -c "umount -lvf /data/arch-arm64" >/dev/null 2>&1
    echo -e '\033[32m[*]\033[34m正在重启\033[35mselinux\033[0m'
    sleep 0.3s
    su -c "setenforce 1"
    echo -e '\033[33m[i]\033[34mAll done!\033[0m'
    echo -e '\033[34m『我萌故我在!』\033[0m'
}
show_help(){
    echo -e "                                 \033[30m ████████████████████████\n                              ████                        ██\n                        ██████                              ████\n                    ████                                        ████\n                ████                                                ██\n          ██████                            ██                        ██\n              ██              ████    ████  ██                          ██\n            ██              ██  ██████    ██  ██                ████      ██\n            ██      ██  ████    ██          ██  ████            ██  ████    ██\n          ██        ████                           ████         ██      ██  ██\n          ██        ██      ██            ██          ██        ██  ██████████\n        ██        ██      ██                ██          ██      ██████████  ██\n        ████    ██      ██                    ████      ██      ████████      ██\n      ████  ██  ██  ████                                ██      ████████      ██\n            ██  ██                                        ██    ██████        ██\n            ██  ██  ██████████                ██████████  ██      ██          ██\n            ██  ████          ██            ██          ████      ██          ██\n            ██  ██    ██████                    ██████    ██      ██          ██\n            ██  ██  ██\033[31m██████\033[30m██                ██\033[31m██████\033[30m██  ██      ██          ██\n          ██    ██  ██\033[31m██\033[30m██\033[31m██\033[30m██                ██\033[31m██\033[30m██\033[31m██\033[30m██  ██      ██          ██\n          ██    ██  ██\033[31m██████\033[30m██                ██\033[31m██████\033[30m██  ██      ██            ██\n          ██    ██  ██\033[31m██████\033[30m██                ██\033[31m██████\033[30m██  ██      ██            ██\n        ██      ██    ██████                    ██████    ██      ██            ██\n      ██  ██  ██                                          ██      ██            ██\n    ██  ██    ██                                          ██      ██            ██\n  ██      ██  ██      ██          ██                      ██      ██            ██\n  ██      ██    ██  ██  ██      ██  ██      ████          ██      ██              ██\n  ██    ████      ████    ████████    ████████  ██  ████  ██      ██              ██\n██████████████  ██████      ██████  ██████████    ████  ██        ██                ██\n██████████████  ██████████████████████████████████████████                          ██\n██████████████    ████████████████████████████████████                              ██\n  ██        ██      ██████  ██████████████████████████          ████                  ██\n  ██          ██    ████      ████    ████    ████  ██          ██                    ██\n  ██            ██████                              ██          ██                    ██\n    ██              ██                            ██            ██                    ██\n      ██          ██                              ██          ████                  ██\n        ██        ██                              ██          ████                ██\n          ██      ██                                ██████████  ██                ██\n            ██████                                              ██                ██\n                ██                                              ██                ██\033[0m"
    echo -e '\033[34m用法：\033[35march \033[32m[\033[34m选项\033[32m]\033[0m'
    echo -e '  \033[33mch\033[34m或\033[33mchroot\033[34m:运行\033[35mchroot\033[34m容器\033[0m'
    echo -e '  \033[33mun\033[34m或\033[33mumount\033[34m:解除系统挂载\033[0m'
}
if [[ $1 == "chroot" || $1 == "ch" ]];then
    run_chroot
elif [[ $1 == "un" || $1 == "umount" ]];then
    umount_system
elif [[ $1 == "h" || $1 == "help" ]];then
    show_help
else
    show_help
fi
